(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const f of o)if(f.type==="childList")for(const p of f.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&i(p)}).observe(document,{childList:!0,subtree:!0});function n(o){const f={};return o.integrity&&(f.integrity=o.integrity),o.referrerPolicy&&(f.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?f.credentials="include":o.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function i(o){if(o.ep)return;o.ep=!0;const f=n(o);fetch(o.href,f)}})();var Ye=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},me={},de={},Ir={exports:{}};(function(e){var t=Object.prototype.hasOwnProperty,n="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(n=!1));function o(_,g,y){this.fn=_,this.context=g,this.once=y||!1}function f(_,g,y,m,T){if(typeof y!="function")throw new TypeError("The listener must be a function");var P=new o(y,m||_,T),b=n?n+g:g;return _._events[b]?_._events[b].fn?_._events[b]=[_._events[b],P]:_._events[b].push(P):(_._events[b]=P,_._eventsCount++),_}function p(_,g){--_._eventsCount===0?_._events=new i:delete _._events[g]}function h(){this._events=new i,this._eventsCount=0}h.prototype.eventNames=function(){var g=[],y,m;if(this._eventsCount===0)return g;for(m in y=this._events)t.call(y,m)&&g.push(n?m.slice(1):m);return Object.getOwnPropertySymbols?g.concat(Object.getOwnPropertySymbols(y)):g},h.prototype.listeners=function(g){var y=n?n+g:g,m=this._events[y];if(!m)return[];if(m.fn)return[m.fn];for(var T=0,P=m.length,b=new Array(P);T<P;T++)b[T]=m[T].fn;return b},h.prototype.listenerCount=function(g){var y=n?n+g:g,m=this._events[y];return m?m.fn?1:m.length:0},h.prototype.emit=function(g,y,m,T,P,b){var L=n?n+g:g;if(!this._events[L])return!1;var S=this._events[L],Y=arguments.length,N,B;if(S.fn){switch(S.once&&this.removeListener(g,S.fn,void 0,!0),Y){case 1:return S.fn.call(S.context),!0;case 2:return S.fn.call(S.context,y),!0;case 3:return S.fn.call(S.context,y,m),!0;case 4:return S.fn.call(S.context,y,m,T),!0;case 5:return S.fn.call(S.context,y,m,T,P),!0;case 6:return S.fn.call(S.context,y,m,T,P,b),!0}for(B=1,N=new Array(Y-1);B<Y;B++)N[B-1]=arguments[B];S.fn.apply(S.context,N)}else{var tt=S.length,ge;for(B=0;B<tt;B++)switch(S[B].once&&this.removeListener(g,S[B].fn,void 0,!0),Y){case 1:S[B].fn.call(S[B].context);break;case 2:S[B].fn.call(S[B].context,y);break;case 3:S[B].fn.call(S[B].context,y,m);break;case 4:S[B].fn.call(S[B].context,y,m,T);break;default:if(!N)for(ge=1,N=new Array(Y-1);ge<Y;ge++)N[ge-1]=arguments[ge];S[B].fn.apply(S[B].context,N)}}return!0},h.prototype.on=function(g,y,m){return f(this,g,y,m,!1)},h.prototype.once=function(g,y,m){return f(this,g,y,m,!0)},h.prototype.removeListener=function(g,y,m,T){var P=n?n+g:g;if(!this._events[P])return this;if(!y)return p(this,P),this;var b=this._events[P];if(b.fn)b.fn===y&&(!T||b.once)&&(!m||b.context===m)&&p(this,P);else{for(var L=0,S=[],Y=b.length;L<Y;L++)(b[L].fn!==y||T&&!b[L].once||m&&b[L].context!==m)&&S.push(b[L]);S.length?this._events[P]=S.length===1?S[0]:S:p(this,P)}return this},h.prototype.removeAllListeners=function(g){var y;return g?(y=n?n+g:g,this._events[y]&&p(this,y)):(this._events=new i,this._eventsCount=0),this},h.prototype.off=h.prototype.removeListener,h.prototype.addListener=h.prototype.on,h.prefixed=n,h.EventEmitter=h,e.exports=h})(Ir);var wr=Ir.exports,Kt=wr.EventEmitter;de.EventEmitter=Kt;de.mixin=Oo;function Oo(e){for(var t in Kt.prototype)e.prototype[t]=Kt.prototype[t]}var Lr=["info","warn","error"];function Cr(){var e={};Lr.forEach(function(t){e[t]=console[t].bind(console)}),this.setMethods(e)}var Ro=Cr;Cr.prototype.setMethods=function(e){e=e||{};var t=this;Lr.forEach(function(n){typeof e[n]=="function"&&(t[n]=e[n])})};var So=Ro,bo=new So,sn=bo;function Ee(e,t){this.code=e,this.message=t||"",Error.captureStackTrace?Error.captureStackTrace(this,Ee):this.stack=new Error().stack}Ee.prototype=Object.create(Error.prototype);Ee.prototype.constructor=Ee;Ee.prototype.name="ShareDBError";Ee.CODES={ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT:"ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT",ERR_APPLY_SNAPSHOT_NOT_PROVIDED:"ERR_APPLY_SNAPSHOT_NOT_PROVIDED",ERR_FIXUP_IS_ONLY_VALID_ON_APPLY:"ERR_FIXUP_IS_ONLY_VALID_ON_APPLY",ERR_CANNOT_FIXUP_DELETION:"ERR_CANNOT_FIXUP_DELETION",ERR_CLIENT_ID_BADLY_FORMED:"ERR_CLIENT_ID_BADLY_FORMED",ERR_CANNOT_PING_OFFLINE:"ERR_CANNOT_PING_OFFLINE",ERR_CONNECTION_SEQ_INTEGER_OVERFLOW:"ERR_CONNECTION_SEQ_INTEGER_OVERFLOW",ERR_CONNECTION_STATE_TRANSITION_INVALID:"ERR_CONNECTION_STATE_TRANSITION_INVALID",ERR_DATABASE_ADAPTER_NOT_FOUND:"ERR_DATABASE_ADAPTER_NOT_FOUND",ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE:"ERR_DATABASE_DOES_NOT_SUPPORT_SUBSCRIBE",ERR_DATABASE_METHOD_NOT_IMPLEMENTED:"ERR_DATABASE_METHOD_NOT_IMPLEMENTED",ERR_DEFAULT_TYPE_MISMATCH:"ERR_DEFAULT_TYPE_MISMATCH",ERR_DOC_MISSING_VERSION:"ERR_DOC_MISSING_VERSION",ERR_DOC_ALREADY_CREATED:"ERR_DOC_ALREADY_CREATED",ERR_DOC_DOES_NOT_EXIST:"ERR_DOC_DOES_NOT_EXIST",ERR_DOC_TYPE_NOT_RECOGNIZED:"ERR_DOC_TYPE_NOT_RECOGNIZED",ERR_DOC_WAS_DELETED:"ERR_DOC_WAS_DELETED",ERR_INFLIGHT_OP_MISSING:"ERR_INFLIGHT_OP_MISSING",ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION:"ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION",ERR_MAX_SUBMIT_RETRIES_EXCEEDED:"ERR_MAX_SUBMIT_RETRIES_EXCEEDED",ERR_MESSAGE_BADLY_FORMED:"ERR_MESSAGE_BADLY_FORMED",ERR_MILESTONE_ARGUMENT_INVALID:"ERR_MILESTONE_ARGUMENT_INVALID",ERR_OP_ALREADY_SUBMITTED:"ERR_OP_ALREADY_SUBMITTED",ERR_OP_NOT_ALLOWED_IN_PROJECTION:"ERR_OP_NOT_ALLOWED_IN_PROJECTION",ERR_OP_SUBMIT_REJECTED:"ERR_OP_SUBMIT_REJECTED",ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM:"ERR_OP_VERSION_MISMATCH_AFTER_TRANSFORM",ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM:"ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM",ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT:"ERR_OP_VERSION_NEWER_THAN_CURRENT_SNAPSHOT",ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED:"ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED",ERR_OT_OP_BADLY_FORMED:"ERR_OT_OP_BADLY_FORMED",ERR_OT_OP_NOT_APPLIED:"ERR_OT_OP_NOT_APPLIED",ERR_OT_OP_NOT_PROVIDED:"ERR_OT_OP_NOT_PROVIDED",ERR_PRESENCE_TRANSFORM_FAILED:"ERR_PRESENCE_TRANSFORM_FAILED",ERR_PROTOCOL_VERSION_NOT_SUPPORTED:"ERR_PROTOCOL_VERSION_NOT_SUPPORTED",ERR_QUERY_CHANNEL_MISSING:"ERR_QUERY_CHANNEL_MISSING",ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED:"ERR_QUERY_EMITTER_LISTENER_NOT_ASSIGNED",ERR_SNAPSHOT_READ_SILENT_REJECTION:"ERR_SNAPSHOT_READ_SILENT_REJECTION",ERR_SNAPSHOT_READS_REJECTED:"ERR_SNAPSHOT_READS_REJECTED",ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND:"ERR_SUBMIT_TRANSFORM_OPS_NOT_FOUND",ERR_TYPE_CANNOT_BE_PROJECTED:"ERR_TYPE_CANNOT_BE_PROJECTED",ERR_TYPE_DOES_NOT_SUPPORT_COMPOSE:"ERR_TYPE_DOES_NOT_SUPPORT_COMPOSE",ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE:"ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE",ERR_UNKNOWN_ERROR:"ERR_UNKNOWN_ERROR"};var Je=Ee,Qe={},Mr=To;function To(e,t,n,i){var o=function(p,h,_,g){t(_,p,h,"left"),t(g,h,p,"right")},f=e.transformX=function(p,h){n(p),n(h);for(var _=[],g=0;g<h.length;g++){for(var y=h[g],m=[],T=0;T<p.length;){var P=[];if(o(p[T],y,m,P),T++,P.length===1)y=P[0];else if(P.length===0){for(var b=T;b<p.length;b++)i(m,p[b]);y=null;break}else{for(var L=f(p.slice(T),P),S=0;S<L[0].length;S++)i(m,L[0][S]);for(var Y=0;Y<L[1].length;Y++)i(_,L[1][Y]);y=null;break}}y!=null&&i(_,y),p=m}return[p,_]};e.transform=function(p,h,_){if(!(_==="left"||_==="right"))throw new Error("type must be 'left' or 'right'");return h.length===0?p:p.length===1&&h.length===1?t([],p[0],h[0],_):_==="left"?f(p,h)[0]:f(h,p)[1]}}var qr={exports:{}},_e=qr.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(e){if(e!=null&&typeof e!="string")throw new Error("Initial data must be a string");return e||""}},en=function(e,t,n){return e.slice(0,t)+n+e.slice(t)},tn=function(e){if(typeof e.p!="number")throw new Error("component missing position field");if(typeof e.i=="string"==(typeof e.d=="string"))throw new Error("component needs an i or d field");if(e.p<0)throw new Error("position cannot be negative")},Pt=function(e){for(var t=0;t<e.length;t++)tn(e[t])};_e.apply=function(e,t){var n;Pt(t);for(var i=0;i<t.length;i++){var o=t[i];if(o.i!=null)e=en(e,o.p,o.i);else{if(n=e.slice(o.p,o.p+o.d.length),o.d!==n)throw new Error("Delete component '"+o.d+"' does not match deleted text '"+n+"'");e=e.slice(0,o.p)+e.slice(o.p+o.d.length)}}return e};var fe=_e._append=function(e,t){if(!(t.i===""||t.d===""))if(e.length===0)e.push(t);else{var n=e[e.length-1];n.i!=null&&t.i!=null&&n.p<=t.p&&t.p<=n.p+n.i.length?e[e.length-1]={i:en(n.i,t.p-n.p,t.i),p:n.p}:n.d!=null&&t.d!=null&&t.p<=n.p&&n.p<=t.p+t.d.length?e[e.length-1]={d:en(t.d,n.p-t.p,n.d),p:t.p}:e.push(t)}};_e.compose=function(e,t){Pt(e),Pt(t);for(var n=e.slice(),i=0;i<t.length;i++)fe(n,t[i]);return n};_e.normalize=function(e){var t=[];(e.i!=null||e.p!=null)&&(e=[e]);for(var n=0;n<e.length;n++){var i=e[n];i.p==null&&(i.p=0),fe(t,i)}return t};var nn=function(e,t,n){return t.i!=null?t.p<e||t.p===e&&n?e+t.i.length:e:e<=t.p?e:e<=t.p+t.d.length?t.p:e-t.d.length};_e.transformCursor=function(e,t,n){for(var i=n==="right",o=0;o<t.length;o++)e=nn(e,t[o],i);return e};var Po=_e._tc=function(e,t,n,i){if(tn(t),tn(n),t.i!=null)fe(e,{i:t.i,p:nn(t.p,n,i==="right")});else if(n.i!=null){var o=t.d;t.p<n.p&&(fe(e,{d:o.slice(0,n.p-t.p),p:t.p}),o=o.slice(n.p-t.p)),o!==""&&fe(e,{d:o,p:t.p+n.i.length})}else if(t.p>=n.p+n.d.length)fe(e,{d:t.d,p:t.p-n.d.length});else if(t.p+t.d.length<=n.p)fe(e,t);else{var f={d:"",p:t.p};t.p<n.p&&(f.d=t.d.slice(0,n.p-t.p)),t.p+t.d.length>n.p+n.d.length&&(f.d+=t.d.slice(n.p+n.d.length-t.p));var p=Math.max(t.p,n.p),h=Math.min(t.p+t.d.length,n.p+n.d.length),_=t.d.slice(p-t.p,h-t.p),g=n.d.slice(p-n.p,h-n.p);if(_!==g)throw new Error("Delete ops delete different text in the same region of the document");f.d!==""&&(f.p=nn(f.p,n),fe(e,f))}return e},Do=function(e){return e.i!=null?{d:e.i,p:e.p}:{i:e.d,p:e.p}};_e.invert=function(e){e=e.slice().reverse();for(var t=0;t<e.length;t++)e[t]=Do(e[t]);return e};Mr(_e,Po,Pt,fe);var Ao=qr.exports,It=function(e){return Object.prototype.toString.call(e)=="[object Array]"},No=function(e){return!!e&&e.constructor===Object},K=function(e){return JSON.parse(JSON.stringify(e))},I={name:"json0",uri:"http://sharejs.org/types/JSONv0"},le={};I.registerSubtype=function(e){le[e.name]=e};I.create=function(e){return e===void 0?null:K(e)};I.invertComponent=function(e){var t={p:e.p};return e.t&&le[e.t]&&(t.t=e.t,t.o=le[e.t].invert(e.o)),e.si!==void 0&&(t.sd=e.si),e.sd!==void 0&&(t.si=e.sd),e.oi!==void 0&&(t.od=e.oi),e.od!==void 0&&(t.oi=e.od),e.li!==void 0&&(t.ld=e.li),e.ld!==void 0&&(t.li=e.ld),e.na!==void 0&&(t.na=-e.na),e.lm!==void 0&&(t.lm=e.p[e.p.length-1],t.p=e.p.slice(0,e.p.length-1).concat([e.lm])),t};I.invert=function(e){for(var t=e.slice().reverse(),n=[],i=0;i<t.length;i++)n.push(I.invertComponent(t[i]));return n};I.checkValidOp=function(e){for(var t=0;t<e.length;t++)if(!It(e[t].p))throw new Error("Missing path")};I.checkList=function(e){if(!It(e))throw new Error("Referenced element not a list")};I.checkObj=function(e){if(!No(e))throw new Error("Referenced element not an object (it was "+JSON.stringify(e)+")")};function xe(e){e.t="text0";var t={p:e.p.pop()};e.si!=null&&(t.i=e.si),e.sd!=null&&(t.d=e.sd),e.o=[t]}function Ge(e){e.p.push(e.o[0].p),e.o[0].i!=null&&(e.si=e.o[0].i),e.o[0].d!=null&&(e.sd=e.o[0].d),delete e.t,delete e.o}I.apply=function(e,t){I.checkValidOp(t),t=K(t);for(var n={data:e},i=0;i<t.length;i++){var o=t[i];(o.si!=null||o.sd!=null)&&xe(o);for(var f=null,p=n,h="data",_=0;_<o.p.length;_++){var g=o.p[_];if(f=p,p=p[h],h=g,f==null)throw new Error("Path invalid")}if(o.t&&o.o!==void 0&&le[o.t])p[h]=le[o.t].apply(p[h],o.o);else if(o.na!==void 0){if(typeof p[h]!="number")throw new Error("Referenced element not a number");p[h]+=o.na}else if(o.li!==void 0&&o.ld!==void 0)I.checkList(p),p[h]=o.li;else if(o.li!==void 0)I.checkList(p),p.splice(h,0,o.li);else if(o.ld!==void 0)I.checkList(p),p.splice(h,1);else if(o.lm!==void 0){if(I.checkList(p),o.lm!=h){var y=p[h];p.splice(h,1),p.splice(o.lm,0,y)}}else if(o.oi!==void 0)I.checkObj(p),p[h]=o.oi;else if(o.od!==void 0)I.checkObj(p),delete p[h];else throw new Error("invalid / missing instruction in op")}return n.data};I.shatter=function(e){for(var t=[],n=0;n<e.length;n++)t.push([e[n]]);return t};I.incrementalApply=function(e,t,n){for(var i=0;i<t.length;i++){var o=[t[i]];e=I.apply(e,o),n(o,e)}return e};var Io=I.pathMatches=function(e,t,n){if(e.length!=t.length)return!1;for(var i=0;i<e.length;i++)if(e[i]!==t[i]&&(!n||i!==e.length-1))return!1;return!0};I.append=function(e,t){if(t=K(t),e.length===0){e.push(t);return}var n=e[e.length-1];if((t.si!=null||t.sd!=null)&&(n.si!=null||n.sd!=null)&&(xe(t),xe(n)),Io(t.p,n.p))if(t.t&&n.t&&t.t===n.t&&le[t.t]){if(n.o=le[t.t].compose(n.o,t.o),t.si!=null||t.sd!=null){for(var i=t.p,o=0;o<n.o.length-1;o++)t.o=[n.o.pop()],t.p=i.slice(),Ge(t),e.push(t);Ge(n)}}else n.na!=null&&t.na!=null?e[e.length-1]={p:n.p,na:n.na+t.na}:n.li!==void 0&&t.li===void 0&&t.ld===n.li?n.ld!==void 0?delete n.li:e.pop():n.od!==void 0&&n.oi===void 0&&t.oi!==void 0&&t.od===void 0?n.oi=t.oi:n.oi!==void 0&&t.od!==void 0?t.oi!==void 0?n.oi=t.oi:n.od!==void 0?delete n.oi:e.pop():t.lm!==void 0&&t.p[t.p.length-1]===t.lm||e.push(t);else(t.si!=null||t.sd!=null)&&(n.si!=null||n.sd!=null)&&(Ge(t),Ge(n)),e.push(t)};I.compose=function(e,t){I.checkValidOp(e),I.checkValidOp(t);for(var n=K(e),i=0;i<t.length;i++)I.append(n,t[i]);return n};I.normalize=function(e){var t=[];e=It(e)?e:[e];for(var n=0;n<e.length;n++){var i=e[n];i.p==null&&(i.p=[]),I.append(t,i)}return t};I.commonLengthForOps=function(e,t){var n=e.p.length,i=t.p.length;if((e.na!=null||e.t)&&n++,(t.na!=null||t.t)&&i++,n===0)return-1;if(i===0)return null;n--,i--;for(var o=0;o<n;o++){var f=e.p[o];if(o>=i||f!==t.p[o])return null}return n};I.canOpAffectPath=function(e,t){return I.commonLengthForOps({p:t},e)!=null};I.transformComponent=function(e,t,n,i){t=K(t);var o=I.commonLengthForOps(n,t),f=I.commonLengthForOps(t,n),p=t.p.length,h=n.p.length;if((t.na!=null||t.t)&&p++,(n.na!=null||n.t)&&h++,f!=null&&h>p&&t.p[f]==n.p[f]){if(t.ld!==void 0){var _=K(n);_.p=_.p.slice(p),t.ld=I.apply(K(t.ld),[_])}else if(t.od!==void 0){var _=K(n);_.p=_.p.slice(p),t.od=I.apply(K(t.od),[_])}}if(o!=null){var g=p==h,_=n;if((t.si!=null||t.sd!=null)&&(n.si!=null||n.sd!=null)&&(xe(t),_=K(n),xe(_)),_.t&&le[_.t]){if(t.t&&t.t===_.t){var y=le[t.t].transform(t.o,_.o,i);if(t.si!=null||t.sd!=null)for(var m=t.p,T=0;T<y.length;T++)t.o=[y[T]],t.p=m.slice(),Ge(t),I.append(e,t);else(!It(y)||y.length>0)&&(t.o=y,I.append(e,t));return e}}else if(n.na===void 0){if(n.li!==void 0&&n.ld!==void 0){if(n.p[o]===t.p[o])if(g){if(t.ld!==void 0)if(t.li!==void 0&&i==="left")t.ld=K(n.li);else return e}else return e}else if(n.li!==void 0)t.li!==void 0&&t.ld===void 0&&g&&t.p[o]===n.p[o]?i==="right"&&t.p[o]++:n.p[o]<=t.p[o]&&t.p[o]++,t.lm!==void 0&&g&&n.p[o]<=t.lm&&t.lm++;else if(n.ld!==void 0){if(t.lm!==void 0&&g){if(n.p[o]===t.p[o])return e;var m=n.p[o],P=t.p[o],b=t.lm;(m<b||m===b&&P<b)&&t.lm--}if(n.p[o]<t.p[o])t.p[o]--;else if(n.p[o]===t.p[o]){if(h<p)return e;if(t.ld!==void 0)if(t.li!==void 0)delete t.ld;else return e}}else if(n.lm!==void 0)if(t.lm!==void 0&&p===h){var P=t.p[o],b=t.lm,L=n.p[o],S=n.lm;if(L!==S)if(P===L)if(i==="left")t.p[o]=S,P===b&&(t.lm=S);else return e;else P>L&&t.p[o]--,P>S?t.p[o]++:P===S&&L>S&&(t.p[o]++,P===b&&t.lm++),(b>L||b===L&&b>P)&&t.lm--,b>S?t.lm++:b===S&&(S>L&&b>P||S<L&&b<P?i==="right"&&t.lm++:b>P?t.lm++:b===L&&t.lm--)}else if(t.li!==void 0&&t.ld===void 0&&g){var P=n.p[o],b=n.lm;m=t.p[o],m>P&&t.p[o]--,m>b&&t.p[o]++}else{var P=n.p[o],b=n.lm;m=t.p[o],m===P?t.p[o]=b:(m>P&&t.p[o]--,(m>b||m===b&&P>b)&&t.p[o]++)}else if(n.oi!==void 0&&n.od!==void 0){if(t.p[o]===n.p[o])if(t.oi!==void 0&&g){if(i==="right")return e;t.od=n.oi}else return e}else if(n.oi!==void 0){if(t.oi!==void 0&&t.p[o]===n.p[o])if(i==="left")I.append(e,{p:t.p,od:n.oi});else return e}else if(n.od!==void 0&&t.p[o]==n.p[o]){if(!g)return e;if(t.oi!==void 0)delete t.od;else return e}}}return I.append(e,t),e};Mr(I,I.transformComponent,I.checkValidOp,I.append);var wo=Ao;I.registerSubtype(wo);var Lo=I,Co={type:Lo};(function(e){e.defaultType=Co.type,e.map={},e.register=function(t){t.name&&(e.map[t.name]=t),t.uri&&(e.map[t.uri]=t)},e.register(e.defaultType)})(Qe);var J={};(function(e){e.doNothing=t;function t(){}e.hasKeys=function(n){for(var i in n)return!0;return!1},e.isInteger=Number.isInteger||function(n){return typeof n=="number"&&isFinite(n)&&Math.floor(n)===n},e.isValidVersion=function(n){return n===null?!0:e.isInteger(n)&&n>=0},e.isValidTimestamp=function(n){return e.isValidVersion(n)},e.MAX_SAFE_INTEGER=9007199254740991,e.dig=function(){for(var n=arguments[0],i=1;i<arguments.length;i++){var o=arguments[i];n=n[o]||(i===arguments.length-1?void 0:{})}return n},e.digOrCreate=function(){for(var n=arguments[0],i=arguments[arguments.length-1],o=1;o<arguments.length-1;o++){var f=arguments[o];n=n[f]||(n[f]=o===arguments.length-2?i():{})}return n},e.digAndRemove=function(){for(var n=arguments[0],i=[n],o=1;o<arguments.length-1;o++){var f=arguments[o];if(!n.hasOwnProperty(f))break;n=n[f],i.push(n)}for(var o=i.length-1;o>=0;o--){var p=i[o],f=arguments[o+1],h=p[f];(o===i.length-1||!e.hasKeys(h))&&delete p[f]}},e.supportsPresence=function(n){return n&&typeof n.transformPresence=="function"},e.callEach=function(n,i){var o=!1;return n.forEach(function(f){f&&(f(i),o=!0)}),o},e.truthy=function(n){return!!n},e.nextTick=function(n){if(typeof process<"u"&&process.nextTick)return process.nextTick.apply(null,arguments);for(var i=[],o=1;o<arguments.length;o++)i[o-1]=arguments[o];setTimeout(function(){n.apply(null,i)})},e.clone=function(n){return n===void 0?void 0:JSON.parse(JSON.stringify(n))}})(J);var br=Array.isArray,Tr=Object.keys,Mo=Object.prototype.hasOwnProperty,qo=function e(t,n){if(t===n)return!0;if(t&&n&&typeof t=="object"&&typeof n=="object"){var i=br(t),o=br(n),f,p,h;if(i&&o){if(p=t.length,p!=n.length)return!1;for(f=p;f--!==0;)if(!e(t[f],n[f]))return!1;return!0}if(i!=o)return!1;var _=t instanceof Date,g=n instanceof Date;if(_!=g)return!1;if(_&&g)return t.getTime()==n.getTime();var y=t instanceof RegExp,m=n instanceof RegExp;if(y!=m)return!1;if(y&&m)return t.toString()==n.toString();var T=Tr(t);if(p=T.length,p!==Tr(n).length)return!1;for(f=p;f--!==0;)if(!Mo.call(n,T[f]))return!1;for(f=p;f--!==0;)if(h=T[f],!e(t[h],n[h]))return!1;return!0}return t!==t&&n!==n},ve={};ve.ACTIONS={initLegacy:"init",handshake:"hs",queryFetch:"qf",querySubscribe:"qs",queryUnsubscribe:"qu",queryUpdate:"q",bulkFetch:"bf",bulkSubscribe:"bs",bulkUnsubscribe:"bu",fetch:"f",fixup:"fixup",subscribe:"s",unsubscribe:"u",op:"op",snapshotFetch:"nf",snapshotFetchByTimestamp:"nt",pingPong:"pp",presence:"p",presenceSubscribe:"ps",presenceUnsubscribe:"pu",presenceRequest:"pr"};var jr=de,jo=sn,z=Je,wt=Qe,ee=J,Fo=ee.clone,Bo=qo,Xt=ve.ACTIONS,k=z.CODES,Fr=w;function w(e,t,n){jr.EventEmitter.call(this),this.connection=e,this.collection=t,this.id=n,this.version=null,this.type=null,this.data=void 0,this.inflightFetch=[],this.inflightSubscribe=null,this.pendingFetch=[],this.pendingSubscribe=[],this.subscribed=!1,this.wantSubscribe=!1,this._wantsDestroy=!1,this.inflightOp=null,this.pendingOps=[],this.type=null,this.applyStack=null,this.preventCompose=!1,this.submitSource=!1,this.paused=!1,this._dataStateVersion=0}jr.mixin(w);w.prototype.destroy=function(e){this._wantsDestroy=!0;var t=this;t.whenNothingPending(function(){t.wantSubscribe?t.unsubscribe(function(n){if(n)return e?e(n):t.emit("error",n);t.connection._destroyDoc(t),e&&e()}):(t.connection._destroyDoc(t),e&&e())})};w.prototype._setType=function(e){if(typeof e=="string"&&(e=wt.map[e]),e)this.type=e;else if(e===null)this.type=e,this._setData(void 0);else{var t=new z(k.ERR_DOC_TYPE_NOT_RECOGNIZED,"Missing type "+e);return this.emit("error",t)}};w.prototype._setData=function(e){this.data=e,this._dataStateVersion++};w.prototype.ingestSnapshot=function(e,t){if(!e)return t&&t();if(typeof e.v!="number"){var n=new z(k.ERR_INGESTED_SNAPSHOT_HAS_NO_VERSION,"Missing version in ingested snapshot. "+this.collection+"."+this.id);return t?t(n):this.emit("error",n)}if(this.type||this.hasWritePending()){if(this.version==null){if(this.hasWritePending())return t&&this.once("no write pending",t);var n=new z(k.ERR_DOC_MISSING_VERSION,"Cannot ingest snapshot in doc with null version. "+this.collection+"."+this.id);return t?t(n):this.emit("error",n)}return e.v>this.version?this.fetch(t):t&&t()}if(this.version>e.v)return t&&t();this.version=e.v;var i=e.type===void 0?wt.defaultType:e.type;this._setType(i),this._setData(this.type&&this.type.deserialize?this.type.deserialize(e.data):e.data),this.emit("load"),t&&t()};w.prototype.whenNothingPending=function(e){var t=this;ee.nextTick(function(){if(t.hasPending()){t.once("nothing pending",e);return}e()})};w.prototype.hasPending=function(){return!!(this.inflightOp||this.pendingOps.length||this.inflightFetch.length||this.inflightSubscribe||this.pendingFetch.length||this.pendingSubscribe.length)};w.prototype.hasWritePending=function(){return!!(this.inflightOp||this.pendingOps.length)};w.prototype._emitNothingPending=function(){this.hasWritePending()||(this.emit("no write pending"),!this.hasPending()&&this.emit("nothing pending"))};w.prototype._emitResponseError=function(e,t){if(e&&e.code===k.ERR_SNAPSHOT_READ_SILENT_REJECTION){this.wantSubscribe=!1,t&&t(),this._emitNothingPending();return}if(t){t(e),this._emitNothingPending();return}this._emitNothingPending(),this.emit("error",e)};w.prototype._handleFetch=function(e,t){var n=this.pendingFetch;this.pendingFetch=[];var i=this.inflightFetch.shift();if(i&&n.push(i),n.length&&(i=function(o){ee.callEach(n,o)}),e)return this._emitResponseError(e,i);this.ingestSnapshot(t,i),this._emitNothingPending()};w.prototype._handleSubscribe=function(e,t){var n=this.inflightSubscribe;this.inflightSubscribe=null;var i=this.pendingFetch;this.pendingFetch=[],n.callback&&i.push(n.callback);var o;if(i.length&&(o=function(f){ee.callEach(i,f)}),e)return this._emitResponseError(e,o);this.subscribed=n.wantSubscribe,this.subscribed?this.ingestSnapshot(t,o):o&&o(),this._emitNothingPending(),this._flushSubscribe()};w.prototype._handleOp=function(e,t){if(e)return this.inflightOp?(e.code===k.ERR_OP_SUBMIT_REJECTED&&(e=null),this._rollback(e)):this.emit("error",e);if(this.inflightOp&&t.src===this.inflightOp.src&&t.seq===this.inflightOp.seq){this._opAcknowledged(t);return}if(this.version==null||t.v>this.version){this.fetch();return}if(!(t.v<this.version)){if(this.inflightOp){var n=ze(this.inflightOp,t);if(n)return this._hardRollback(n)}for(var i=0;i<this.pendingOps.length;i++){var n=ze(this.pendingOps[i],t);if(n)return this._hardRollback(n)}this.version++;try{this._otApply(t,!1)}catch(o){return this._hardRollback(o)}}};w.prototype._onConnectionStateChanged=function(){this.connection.canSend?(this.flush(),this._resubscribe()):(this.inflightOp&&(this.pendingOps.unshift(this.inflightOp),this.inflightOp=null),this.subscribed=!1,this.inflightSubscribe&&(this.inflightSubscribe.wantSubscribe?(this.pendingSubscribe.unshift(this.inflightSubscribe),this.inflightSubscribe=null):this._handleSubscribe()),this.inflightFetch.length&&(this.pendingFetch=this.pendingFetch.concat(this.inflightFetch),this.inflightFetch.length=0))};w.prototype._resubscribe=function(){if(!this.pendingSubscribe.length&&this.wantSubscribe)return this.subscribe();var e=this.pendingSubscribe.some(function(t){return t.wantSubscribe});!e&&this.pendingFetch.length&&this.fetch(),this._flushSubscribe()};w.prototype.fetch=function(e){if(this.connection.canSend){var t=this.connection.sendFetch(this);Vo(this.inflightFetch,t,e);return}this.pendingFetch.push(e)};w.prototype.subscribe=function(e){var t=!0;this._queueSubscribe(t,e)};w.prototype.unsubscribe=function(e){var t=!1;this._queueSubscribe(t,e)};w.prototype._queueSubscribe=function(e,t){var n=this.pendingSubscribe[this.pendingSubscribe.length-1]||this.inflightSubscribe,i=n&&n.wantSubscribe===e;if(i){n.callback=$o([n.callback,t]);return}this.pendingSubscribe.push({wantSubscribe:!!e,callback:t}),this._flushSubscribe()};w.prototype._flushSubscribe=function(){if(!(this.inflightSubscribe||!this.pendingSubscribe.length)){if(this.connection.canSend){this.inflightSubscribe=this.pendingSubscribe.shift(),this.wantSubscribe=this.inflightSubscribe.wantSubscribe,this.wantSubscribe?this.connection.sendSubscribe(this):(this.subscribed=!1,this.connection.sendUnsubscribe(this));return}if(!this.pendingSubscribe[0].wantSubscribe){this.inflightSubscribe=this.pendingSubscribe.shift();var e=this;ee.nextTick(function(){e._handleSubscribe()})}}};function Vo(e,t,n){if(t){var i=e.pop();e.push(function(o){i&&i(o),n&&n(o)})}else e.push(n)}function $o(e){return e=e.filter(ee.truthy),e.length?function(t){ee.callEach(e,t)}:null}w.prototype.flush=function(){!this.connection.canSend||this.inflightOp||!this.paused&&this.pendingOps.length&&this._sendOp()};function Uo(e){delete e.op,delete e.create,delete e.del}function ze(e,t){if(e.del)return Uo(t);if(t.del)return new z(k.ERR_DOC_WAS_DELETED,"Document was deleted");if(t.create)return new z(k.ERR_DOC_ALREADY_CREATED,"Document already created");if("op"in t){if(e.create)return new z(k.ERR_DOC_ALREADY_CREATED,"Document already created");if(e.type.transformX){var n=e.type.transformX(e.op,t.op);e.op=n[0],t.op=n[1]}else{var i=e.type.transform(e.op,t.op,"left"),o=e.type.transform(t.op,e.op,"right");e.op=i,t.op=o}}}w.prototype._otApply=function(e,t){if("op"in e){if(!this.type)throw new z(k.ERR_DOC_DOES_NOT_EXIST,"Cannot apply op to uncreated document. "+this.collection+"."+this.id);if(this.emit("before op batch",e.op,t),!t&&this.type===wt.defaultType&&e.op.length>1){this.applyStack||(this.applyStack=[]);for(var n=this.applyStack.length,i=0;i<e.op.length;i++){var o=e.op[i],f={op:[o]};this.emit("before op",f.op,t,e.src);for(var p=n;p<this.applyStack.length;p++){var h=ze(this.applyStack[p],f);if(h)return this._hardRollback(h)}this._setData(this.type.apply(this.data,f.op)),this.emit("op",f.op,t,e.src)}this.emit("op batch",e.op,t),this._popApplyStack(n);return}this.emit("before op",e.op,t,e.src),this._setData(this.type.apply(this.data,e.op)),this.emit("op",e.op,t,e.src),this.emit("op batch",e.op,t);return}if(e.create){this._setType(e.create.type),this.type.deserialize?this.type.createDeserialized?this._setData(this.type.createDeserialized(e.create.data)):this._setData(this.type.deserialize(this.type.create(e.create.data))):this._setData(this.type.create(e.create.data)),this.emit("create",t);return}if(e.del){var _=this.data;this._setType(null),this.emit("del",_,t);return}};w.prototype._sendOp=function(){if(this.connection.canSend){var e=this.connection.id;this.inflightOp||(this.inflightOp=this.pendingOps.shift());var t=this.inflightOp;if(!t){var n=new z(k.ERR_INFLIGHT_OP_MISSING,"No op to send on call to _sendOp");return this.emit("error",n)}if(t.sentAt=Date.now(),t.retries=t.retries==null?0:t.retries+1,t.seq==null){if(this.connection.seq>=ee.MAX_SAFE_INTEGER)return this.emit("error",new z(k.ERR_CONNECTION_SEQ_INTEGER_OVERFLOW,"Connection seq has exceeded the max safe integer, maybe from being open for too long"));t.seq=this.connection.seq++}this.connection.sendOp(this,t),t.src==null&&(t.src=e)}};w.prototype._submit=function(e,t,n){if(t||(t=!0),"op"in e){if(!this.type){var i=new z(k.ERR_DOC_DOES_NOT_EXIST,"Cannot submit op. Document has not been created. "+this.collection+"."+this.id);return n?n(i):this.emit("error",i)}this.type.normalize&&(e.op=this.type.normalize(e.op))}try{this._pushOp(e,t,n),this._otApply(e,t)}catch(f){return this._hardRollback(f)}var o=this;ee.nextTick(function(){o.flush()})};w.prototype._pushOp=function(e,t,n){if(e.source=t,this.applyStack)this.applyStack.push(e);else{var i=this._tryCompose(e);if(i){i.callbacks.push(n);return}}e.type=this.type,e.callbacks=[n],this.pendingOps.push(e)};w.prototype._popApplyStack=function(e){if(e>0){this.applyStack.length=e;return}var t=this.applyStack[0];if(this.applyStack=null,!!t){var n=this.pendingOps.indexOf(t);if(n!==-1)for(var i=this.pendingOps.splice(n),n=0;n<i.length;n++){var t=i[n],o=this._tryCompose(t);o?o.callbacks=o.callbacks.concat(t.callbacks):this.pendingOps.push(t)}}};w.prototype._tryCompose=function(e){if(!this.preventCompose){var t=this.pendingOps[this.pendingOps.length-1];if(!(!t||t.sentAt)&&!(this.submitSource&&!Bo(e.source,t.source))){if(t.create&&"op"in e)return t.create.data=this.type.apply(t.create.data,e.op),t;if("op"in t&&"op"in e&&this.type.compose)return t.op=this.type.compose(t.op,e.op),t}}};w.prototype.submitOp=function(e,t,n){typeof t=="function"&&(n=t,t=null);var i={op:e},o=t&&t.source;this._submit(i,o,n)};w.prototype.create=function(e,t,n,i){if(typeof t=="function"?(i=t,n=null,t=null):typeof n=="function"&&(i=n,n=null),t||(t=wt.defaultType.uri),this.type){var o=new z(k.ERR_DOC_ALREADY_CREATED,"Document already exists");return i?i(o):this.emit("error",o)}var f={create:{type:t,data:e}},p=n&&n.source;this._submit(f,p,i)};w.prototype.del=function(e,t){if(typeof e=="function"&&(t=e,e=null),!this.type){var n=new z(k.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");return t?t(n):this.emit("error",n)}var i={del:!0},o=e&&e.source;this._submit(i,o,t)};w.prototype.pause=function(){this.paused=!0};w.prototype.resume=function(){this.paused=!1,this.flush()};w.prototype.toSnapshot=function(){return{v:this.version,data:Fo(this.data),type:this.type.uri}};w.prototype._opAcknowledged=function(e){if(this.inflightOp.create)this.version=e.v;else if(e.v!==this.version)return jo.warn("Invalid version from server. Expected: "+this.version+" Received: "+e.v,e),this.fetch();if(e[Xt.fixup])for(var t=0;t<e[Xt.fixup].length;t++){for(var n=e[Xt.fixup][t],i=0;i<this.pendingOps.length;i++){var o=ze(this.pendingOps[t],n);if(o)return this._hardRollback(o)}try{this._otApply(n,!1)}catch(f){return this._hardRollback(f)}}this.version++,this._clearInflightOp()};w.prototype._rollback=function(e){var t=this.inflightOp;if("op"in t&&t.type.invert){try{t.op=t.type.invert(t.op)}catch{return this._hardRollback(e)}for(var n=0;n<this.pendingOps.length;n++){var i=ze(this.pendingOps[n],t);if(i)return this._hardRollback(i)}try{this._otApply(t,!1)}catch(o){return this._hardRollback(o)}this._clearInflightOp(e);return}this._hardRollback(e)};w.prototype._hardRollback=function(e){var t=[];this.inflightOp&&t.push(this.inflightOp),t=t.concat(this.pendingOps),this._setType(null),this.version=null,this.inflightOp=null,this.pendingOps=[];var n=this;this.fetch(function(){for(var i=!!t.length,o=0;o<t.length;o++)i=ee.callEach(t[o].callbacks,e)&&i;if(e&&!i)return n.emit("error",e)})};w.prototype._clearInflightOp=function(e){var t=this.inflightOp;this.inflightOp=null;var n=ee.callEach(t.callbacks,e);if(this.flush(),this._emitNothingPending(),e&&!n)return this.emit("error",e)};var Br=de,Pr=ve.ACTIONS,Ho=J,Vr=x;function x(e,t,n,i,o,f,p){Br.EventEmitter.call(this),this.action=e,this.connection=t,this.id=n,this.collection=i,this.query=o,this.results=null,f&&f.results&&(this.results=f.results,delete f.results),this.extra=void 0,this.options=f,this.callback=p,this.ready=!1,this.sent=!1}Br.mixin(x);x.prototype.hasPending=function(){return!this.ready};x.prototype.send=function(){if(this.connection.canSend){var e={a:this.action,id:this.id,c:this.collection,q:this.query};if(this.options&&(e.o=this.options),this.results){for(var t=[],n=0;n<this.results.length;n++){var i=this.results[n];t.push([i.id,i.version])}e.r=t}this.connection.send(e),this.sent=!0}};x.prototype.destroy=function(e){this.connection.canSend&&this.action===Pr.querySubscribe&&this.connection.send({a:Pr.queryUnsubscribe,id:this.id}),this.connection._destroyQuery(this),e&&Ho.nextTick(e)};x.prototype._onConnectionStateChanged=function(){this.connection.canSend&&!this.sent?this.send():this.sent=!1};x.prototype._handleFetch=function(e,t,n){this.connection._destroyQuery(this),this._handleResponse(e,t,n)};x.prototype._handleSubscribe=function(e,t,n){this._handleResponse(e,t,n)};x.prototype._handleResponse=function(e,t,n){var i=this.callback;if(this.callback=null,e)return this._finishResponse(e,i);if(!t)return this._finishResponse(null,i);var o=this,f=1,p=function(y){if(y)return o._finishResponse(y,i);--f||o._finishResponse(null,i)};if(Array.isArray(t))f+=t.length,this.results=this._ingestSnapshots(t,p),this.extra=n;else for(var h in t){f++;var _=t[h],g=this.connection.get(_.c||this.collection,h);g.ingestSnapshot(_,p)}p()};x.prototype._ingestSnapshots=function(e,t){for(var n=[],i=0;i<e.length;i++){var o=e[i],f=this.connection.get(o.c||this.collection,o.d);f.ingestSnapshot(o,t),n.push(f)}return n};x.prototype._finishResponse=function(e,t){if(this.emit("ready"),this.ready=!0,e)return this.connection._destroyQuery(this),t?t(e):this.emit("error",e);t&&t(null,this.results,this.extra)};x.prototype._handleError=function(e){this.emit("error",e)};x.prototype._handleDiff=function(e){for(var t=0;t<e.length;t++){var n=e[t];n.type==="insert"&&(n.values=this._ingestSnapshots(n.values))}for(var t=0;t<e.length;t++){var n=e[t];switch(n.type){case"insert":var i=n.values;Array.prototype.splice.apply(this.results,[n.index,0].concat(i)),this.emit("insert",i,n.index);break;case"remove":var f=n.howMany||1,o=this.results.splice(n.index,f);this.emit("remove",o,n.index);break;case"move":var f=n.howMany||1,p=this.results.splice(n.from,f);Array.prototype.splice.apply(this.results,[n.to,0].concat(p)),this.emit("move",p,n.from,n.to);break}}this.emit("changed",this.results)};x.prototype._handleExtra=function(e){this.extra=e,this.emit("extra",e)};var $r=de,Yo=ve.ACTIONS,Go=J,Ur=ae;function ae(e,t){if($r.EventEmitter.call(this),!t||typeof t!="string")throw new Error("LocalPresence presenceId must be a string");this.presence=e,this.presenceId=t,this.connection=e.connection,this.presenceVersion=0,this.value=null,this._pendingMessages=[],this._callbacksByPresenceVersion={}}$r.mixin(ae);ae.prototype.submit=function(e,t){this.value=e,this.send(t)};ae.prototype.send=function(e){var t=this._message();this._pendingMessages.push(t),this._callbacksByPresenceVersion[t.pv]=e,this._sendPending()};ae.prototype.destroy=function(e){var t=this;this.submit(null,function(n){if(n)return t._callbackOrEmit(n,e);delete t.presence.localPresences[t.presenceId],e&&e()})};ae.prototype._sendPending=function(){if(this.connection.canSend){var e=this;this._pendingMessages.forEach(function(t){e.connection.send(t)}),this._pendingMessages=[]}};ae.prototype._ack=function(e,t){var n=this._getCallback(t);this._callbackOrEmit(e,n)};ae.prototype._message=function(){return{a:Yo.presence,ch:this.presence.channel,id:this.presenceId,p:this.value,pv:this.presenceVersion++}};ae.prototype._getCallback=function(e){var t=this._callbacksByPresenceVersion[e];return delete this._callbacksByPresenceVersion[e],t};ae.prototype._callbackOrEmit=function(e,t){if(t)return Go.nextTick(t,e);e&&this.emit("error",e)};var ko=J,Hr=on;function on(e,t){this.presence=e,this.presenceId=t,this.connection=this.presence.connection,this.value=null,this.presenceVersion=0}on.prototype.receiveUpdate=function(e){e.pv<this.presenceVersion||(this.value=e.p,this.presenceVersion=e.pv,this.presence._updateRemotePresence(this))};on.prototype.destroy=function(e){delete this.presence._remotePresenceInstances[this.presenceId],delete this.presence.remotePresences[this.presenceId],e&&ko.nextTick(e)};var Dt={exports:{}};Dt.exports;(function(e,t){(function(n,i){i(t)})(Ye,function(n){function i(r,s){s=s|0;for(var a=Math.max(r.length-s,0),u=Array(a),c=0;c<a;c++)u[c]=r[s+c];return u}var o=function(r){var s=i(arguments,1);return function(){var a=i(arguments);return r.apply(null,s.concat(a))}},f=function(r){return function(){var s=i(arguments),a=s.pop();r.call(this,s,a)}};function p(r){var s=typeof r;return r!=null&&(s=="object"||s=="function")}var h=typeof setImmediate=="function"&&setImmediate,_=typeof process=="object"&&typeof process.nextTick=="function";function g(r){setTimeout(r,0)}function y(r){return function(s){var a=i(arguments,1);r(function(){s.apply(null,a)})}}var m;h?m=setImmediate:_?m=process.nextTick:m=g;var T=y(m);function P(r){return f(function(s,a){var u;try{u=r.apply(this,s)}catch(c){return a(c)}p(u)&&typeof u.then=="function"?u.then(function(c){b(a,null,c)},function(c){b(a,c.message?c:new Error(c))}):a(null,u)})}function b(r,s,a){try{r(s,a)}catch(u){T(L,u)}}function L(r){throw r}var S=typeof Symbol=="function";function Y(r){return S&&r[Symbol.toStringTag]==="AsyncFunction"}function N(r){return Y(r)?P(r):r}function B(r){return function(s){var a=i(arguments,1),u=f(function(c,l){var d=this;return r(s,function(v,E){N(v).apply(d,c.concat(E))},l)});return a.length?u.apply(this,a):u}}var tt=typeof Ye=="object"&&Ye&&Ye.Object===Object&&Ye,ge=typeof self=="object"&&self&&self.Object===Object&&self,fn=tt||ge||Function("return this")(),Oe=fn.Symbol,ln=Object.prototype,ri=ln.hasOwnProperty,ii=ln.toString,Le=Oe?Oe.toStringTag:void 0;function si(r){var s=ri.call(r,Le),a=r[Le];try{r[Le]=void 0;var u=!0}catch{}var c=ii.call(r);return u&&(s?r[Le]=a:delete r[Le]),c}var oi=Object.prototype,ai=oi.toString;function ui(r){return ai.call(r)}var fi="[object Null]",li="[object Undefined]",cn=Oe?Oe.toStringTag:void 0;function nt(r){return r==null?r===void 0?li:fi:cn&&cn in Object(r)?si(r):ui(r)}var ci="[object AsyncFunction]",hi="[object Function]",pi="[object GeneratorFunction]",di="[object Proxy]";function _i(r){if(!p(r))return!1;var s=nt(r);return s==hi||s==pi||s==ci||s==di}var vi=9007199254740991;function hn(r){return typeof r=="number"&&r>-1&&r%1==0&&r<=vi}function Ce(r){return r!=null&&hn(r.length)&&!_i(r)}var Lt={};function C(){}function ce(r){return function(){if(r!==null){var s=r;r=null,s.apply(this,arguments)}}}var Ct=typeof Symbol=="function"&&Symbol.iterator,gi=function(r){return Ct&&r[Ct]&&r[Ct]()};function yi(r,s){for(var a=-1,u=Array(r);++a<r;)u[a]=s(a);return u}function rt(r){return r!=null&&typeof r=="object"}var Ei="[object Arguments]";function pn(r){return rt(r)&&nt(r)==Ei}var dn=Object.prototype,mi=dn.hasOwnProperty,Oi=dn.propertyIsEnumerable,Ri=pn(function(){return arguments}())?pn:function(r){return rt(r)&&mi.call(r,"callee")&&!Oi.call(r,"callee")},X=Array.isArray;function Si(){return!1}var _n=typeof n=="object"&&n&&!n.nodeType&&n,vn=_n&&!0&&e&&!e.nodeType&&e,bi=vn&&vn.exports===_n,gn=bi?fn.Buffer:void 0,Ti=gn?gn.isBuffer:void 0,Pi=Ti||Si,Di=9007199254740991,Ai=/^(?:0|[1-9]\d*)$/;function Ni(r,s){var a=typeof r;return s=s??Di,!!s&&(a=="number"||a!="symbol"&&Ai.test(r))&&r>-1&&r%1==0&&r<s}var Ii="[object Arguments]",wi="[object Array]",Li="[object Boolean]",Ci="[object Date]",Mi="[object Error]",qi="[object Function]",ji="[object Map]",Fi="[object Number]",Bi="[object Object]",Vi="[object RegExp]",$i="[object Set]",Ui="[object String]",Hi="[object WeakMap]",Yi="[object ArrayBuffer]",Gi="[object DataView]",ki="[object Float32Array]",xi="[object Float64Array]",zi="[object Int8Array]",Wi="[object Int16Array]",Ji="[object Int32Array]",Qi="[object Uint8Array]",Xi="[object Uint8ClampedArray]",Zi="[object Uint16Array]",Ki="[object Uint32Array]",q={};q[ki]=q[xi]=q[zi]=q[Wi]=q[Ji]=q[Qi]=q[Xi]=q[Zi]=q[Ki]=!0,q[Ii]=q[wi]=q[Yi]=q[Li]=q[Gi]=q[Ci]=q[Mi]=q[qi]=q[ji]=q[Fi]=q[Bi]=q[Vi]=q[$i]=q[Ui]=q[Hi]=!1;function es(r){return rt(r)&&hn(r.length)&&!!q[nt(r)]}function ts(r){return function(s){return r(s)}}var yn=typeof n=="object"&&n&&!n.nodeType&&n,Me=yn&&!0&&e&&!e.nodeType&&e,ns=Me&&Me.exports===yn,Mt=ns&&tt.process,En=function(){try{var r=Me&&Me.require&&Me.require("util").types;return r||Mt&&Mt.binding&&Mt.binding("util")}catch{}}(),mn=En&&En.isTypedArray,rs=mn?ts(mn):es,is=Object.prototype,ss=is.hasOwnProperty;function os(r,s){var a=X(r),u=!a&&Ri(r),c=!a&&!u&&Pi(r),l=!a&&!u&&!c&&rs(r),d=a||u||c||l,v=d?yi(r.length,String):[],E=v.length;for(var R in r)(s||ss.call(r,R))&&!(d&&(R=="length"||c&&(R=="offset"||R=="parent")||l&&(R=="buffer"||R=="byteLength"||R=="byteOffset")||Ni(R,E)))&&v.push(R);return v}var as=Object.prototype;function us(r){var s=r&&r.constructor,a=typeof s=="function"&&s.prototype||as;return r===a}function fs(r,s){return function(a){return r(s(a))}}var ls=fs(Object.keys,Object),cs=Object.prototype,hs=cs.hasOwnProperty;function ps(r){if(!us(r))return ls(r);var s=[];for(var a in Object(r))hs.call(r,a)&&a!="constructor"&&s.push(a);return s}function qt(r){return Ce(r)?os(r):ps(r)}function ds(r){var s=-1,a=r.length;return function(){return++s<a?{value:r[s],key:s}:null}}function _s(r){var s=-1;return function(){var u=r.next();return u.done?null:(s++,{value:u.value,key:s})}}function vs(r){var s=qt(r),a=-1,u=s.length;return function c(){var l=s[++a];return l==="__proto__"?c():a<u?{value:r[l],key:l}:null}}function gs(r){if(Ce(r))return ds(r);var s=gi(r);return s?_s(s):vs(r)}function re(r){return function(){if(r===null)throw new Error("Callback was already called.");var s=r;r=null,s.apply(this,arguments)}}function it(r){return function(s,a,u){if(u=ce(u||C),r<=0||!s)return u(null);var c=gs(s),l=!1,d=0,v=!1;function E(O,A){if(d-=1,O)l=!0,u(O);else{if(A===Lt||l&&d<=0)return l=!0,u(null);v||R()}}function R(){for(v=!0;d<r&&!l;){var O=c();if(O===null){l=!0,d<=0&&u(null);return}d+=1,a(O.value,O.key,re(E))}v=!1}R()}}function ye(r,s,a,u){it(s)(r,N(a),u)}function H(r,s){return function(a,u,c){return r(a,s,u,c)}}function ys(r,s,a){a=ce(a||C);var u=0,c=0,l=r.length;l===0&&a(null);function d(v,E){v?a(v):(++c===l||E===Lt)&&a(null)}for(;u<l;u++)s(r[u],u,re(d))}var Es=H(ye,1/0),he=function(r,s,a){var u=Ce(r)?ys:Es;u(r,N(s),a)};function Re(r){return function(s,a,u){return r(he,s,N(a),u)}}function On(r,s,a,u){u=u||C,s=s||[];var c=[],l=0,d=N(a);r(s,function(v,E,R){var O=l++;d(v,function(A,j){c[O]=j,R(A)})},function(v){u(v,c)})}var st=Re(On),Rn=B(st);function Se(r){return function(s,a,u,c){return r(it(a),s,N(u),c)}}var be=Se(On),jt=H(be,1),Sn=B(jt);function ot(r,s){for(var a=-1,u=r==null?0:r.length;++a<u&&s(r[a],a,r)!==!1;);return r}function ms(r){return function(s,a,u){for(var c=-1,l=Object(s),d=u(s),v=d.length;v--;){var E=d[r?v:++c];if(a(l[E],E,l)===!1)break}return s}}var Os=ms();function qe(r,s){return r&&Os(r,s,qt)}function Rs(r,s,a,u){for(var c=r.length,l=a+(u?1:-1);u?l--:++l<c;)if(s(r[l],l,r))return l;return-1}function Ss(r){return r!==r}function bs(r,s,a){for(var u=a-1,c=r.length;++u<c;)if(r[u]===s)return u;return-1}function at(r,s,a){return s===s?bs(r,s,a):Rs(r,Ss,a)}var Ft=function(r,s,a){typeof s=="function"&&(a=s,s=null),a=ce(a||C);var u=qt(r),c=u.length;if(!c)return a(null);s||(s=c);var l={},d=0,v=!1,E=Object.create(null),R=[],O=[],A={};qe(r,function(F,V){if(!X(F)){j(V,[F]),O.push(V);return}var U=F.slice(0,F.length-1),ue=U.length;if(ue===0){j(V,F),O.push(V);return}A[V]=ue,ot(U,function(Ae){if(!r[Ae])throw new Error("async.auto task `"+V+"` has a non-existent dependency `"+Ae+"` in "+U.join(", "));ie(Ae,function(){ue--,ue===0&&j(V,F)})})}),go(),G();function j(F,V){R.push(function(){se(F,V)})}function G(){if(R.length===0&&d===0)return a(null,l);for(;R.length&&d<s;){var F=R.shift();F()}}function ie(F,V){var U=E[F];U||(U=E[F]=[]),U.push(V)}function W(F){var V=E[F]||[];ot(V,function(U){U()}),G()}function se(F,V){if(!v){var U=re(function(Ae,Jt){if(d--,arguments.length>2&&(Jt=i(arguments,1)),Ae){var Qt={};qe(l,function(Eo,mo){Qt[mo]=Eo}),Qt[F]=Jt,v=!0,E=Object.create(null),a(Ae,Qt)}else l[F]=Jt,W(F)});d++;var ue=N(V[V.length-1]);V.length>1?ue(l,U):ue(U)}}function go(){for(var F,V=0;O.length;)F=O.pop(),V++,ot(yo(F),function(U){--A[U]===0&&O.push(U)});if(V!==c)throw new Error("async.auto cannot execute tasks due to a recursive dependency")}function yo(F){var V=[];return qe(r,function(U,ue){X(U)&&at(U,F,0)>=0&&V.push(ue)}),V}};function Te(r,s){for(var a=-1,u=r==null?0:r.length,c=Array(u);++a<u;)c[a]=s(r[a],a,r);return c}var Ts="[object Symbol]";function Ps(r){return typeof r=="symbol"||rt(r)&&nt(r)==Ts}var Ds=1/0,bn=Oe?Oe.prototype:void 0,Tn=bn?bn.toString:void 0;function Bt(r){if(typeof r=="string")return r;if(X(r))return Te(r,Bt)+"";if(Ps(r))return Tn?Tn.call(r):"";var s=r+"";return s=="0"&&1/r==-Ds?"-0":s}function As(r,s,a){var u=-1,c=r.length;s<0&&(s=-s>c?0:c+s),a=a>c?c:a,a<0&&(a+=c),c=s>a?0:a-s>>>0,s>>>=0;for(var l=Array(c);++u<c;)l[u]=r[u+s];return l}function Ns(r,s,a){var u=r.length;return a=a===void 0?u:a,!s&&a>=u?r:As(r,s,a)}function Is(r,s){for(var a=r.length;a--&&at(s,r[a],0)>-1;);return a}function ws(r,s){for(var a=-1,u=r.length;++a<u&&at(s,r[a],0)>-1;);return a}function Ls(r){return r.split("")}var Cs="\\ud800-\\udfff",Ms="\\u0300-\\u036f",qs="\\ufe20-\\ufe2f",js="\\u20d0-\\u20ff",Fs=Ms+qs+js,Bs="\\ufe0e\\ufe0f",Vs="\\u200d",$s=RegExp("["+Vs+Cs+Fs+Bs+"]");function Us(r){return $s.test(r)}var Pn="\\ud800-\\udfff",Hs="\\u0300-\\u036f",Ys="\\ufe20-\\ufe2f",Gs="\\u20d0-\\u20ff",ks=Hs+Ys+Gs,xs="\\ufe0e\\ufe0f",zs="["+Pn+"]",Vt="["+ks+"]",$t="\\ud83c[\\udffb-\\udfff]",Ws="(?:"+Vt+"|"+$t+")",Dn="[^"+Pn+"]",An="(?:\\ud83c[\\udde6-\\uddff]){2}",Nn="[\\ud800-\\udbff][\\udc00-\\udfff]",Js="\\u200d",In=Ws+"?",wn="["+xs+"]?",Qs="(?:"+Js+"(?:"+[Dn,An,Nn].join("|")+")"+wn+In+")*",Xs=wn+In+Qs,Zs="(?:"+[Dn+Vt+"?",Vt,An,Nn,zs].join("|")+")",Ks=RegExp($t+"(?="+$t+")|"+Zs+Xs,"g");function eo(r){return r.match(Ks)||[]}function Ln(r){return Us(r)?eo(r):Ls(r)}function to(r){return r==null?"":Bt(r)}var no=/^\s+|\s+$/g;function ro(r,s,a){if(r=to(r),r&&(a||s===void 0))return r.replace(no,"");if(!r||!(s=Bt(s)))return r;var u=Ln(r),c=Ln(s),l=ws(u,c),d=Is(u,c)+1;return Ns(u,l,d).join("")}var io=/^(?:async\s+)?(function)?\s*[^\(]*\(\s*([^\)]*)\)/m,so=/,/,oo=/(=.+)?(\s*)$/,ao=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg;function uo(r){return r=r.toString().replace(ao,""),r=r.match(io)[2].replace(" ",""),r=r?r.split(so):[],r=r.map(function(s){return ro(s.replace(oo,""))}),r}function Cn(r,s){var a={};qe(r,function(u,c){var l,d=Y(u),v=!d&&u.length===1||d&&u.length===0;if(X(u))l=u.slice(0,-1),u=u[u.length-1],a[c]=l.concat(l.length>0?E:u);else if(v)a[c]=u;else{if(l=uo(u),u.length===0&&!d&&l.length===0)throw new Error("autoInject task functions require explicit parameters.");d||l.pop(),a[c]=l.concat(E)}function E(R,O){var A=Te(l,function(j){return R[j]});A.push(O),N(u).apply(null,A)}}),Ft(a,s)}function Z(){this.head=this.tail=null,this.length=0}function Mn(r,s){r.length=1,r.head=r.tail=s}Z.prototype.removeLink=function(r){return r.prev?r.prev.next=r.next:this.head=r.next,r.next?r.next.prev=r.prev:this.tail=r.prev,r.prev=r.next=null,this.length-=1,r},Z.prototype.empty=function(){for(;this.head;)this.shift();return this},Z.prototype.insertAfter=function(r,s){s.prev=r,s.next=r.next,r.next?r.next.prev=s:this.tail=s,r.next=s,this.length+=1},Z.prototype.insertBefore=function(r,s){s.prev=r.prev,s.next=r,r.prev?r.prev.next=s:this.head=s,r.prev=s,this.length+=1},Z.prototype.unshift=function(r){this.head?this.insertBefore(this.head,r):Mn(this,r)},Z.prototype.push=function(r){this.tail?this.insertAfter(this.tail,r):Mn(this,r)},Z.prototype.shift=function(){return this.head&&this.removeLink(this.head)},Z.prototype.pop=function(){return this.tail&&this.removeLink(this.tail)},Z.prototype.toArray=function(){for(var r=Array(this.length),s=this.head,a=0;a<this.length;a++)r[a]=s.data,s=s.next;return r},Z.prototype.remove=function(r){for(var s=this.head;s;){var a=s.next;r(s)&&this.removeLink(s),s=a}return this};function qn(r,s,a){if(s==null)s=1;else if(s===0)throw new Error("Concurrency must not be zero");var u=N(r),c=0,l=[],d=!1;function v(A,j,G){if(G!=null&&typeof G!="function")throw new Error("task callback must be a function");if(O.started=!0,X(A)||(A=[A]),A.length===0&&O.idle())return T(function(){O.drain()});for(var ie=0,W=A.length;ie<W;ie++){var se={data:A[ie],callback:G||C};j?O._tasks.unshift(se):O._tasks.push(se)}d||(d=!0,T(function(){d=!1,O.process()}))}function E(A){return function(j){c-=1;for(var G=0,ie=A.length;G<ie;G++){var W=A[G],se=at(l,W,0);se===0?l.shift():se>0&&l.splice(se,1),W.callback.apply(W,arguments),j!=null&&O.error(j,W.data)}c<=O.concurrency-O.buffer&&O.unsaturated(),O.idle()&&O.drain(),O.process()}}var R=!1,O={_tasks:new Z,concurrency:s,payload:a,saturated:C,unsaturated:C,buffer:s/4,empty:C,drain:C,error:C,started:!1,paused:!1,push:function(A,j){v(A,!1,j)},kill:function(){O.drain=C,O._tasks.empty()},unshift:function(A,j){v(A,!0,j)},remove:function(A){O._tasks.remove(A)},process:function(){if(!R){for(R=!0;!O.paused&&c<O.concurrency&&O._tasks.length;){var A=[],j=[],G=O._tasks.length;O.payload&&(G=Math.min(G,O.payload));for(var ie=0;ie<G;ie++){var W=O._tasks.shift();A.push(W),l.push(W),j.push(W.data)}c+=1,O._tasks.length===0&&O.empty(),c===O.concurrency&&O.saturated();var se=re(E(A));u(j,se)}R=!1}},length:function(){return O._tasks.length},running:function(){return c},workersList:function(){return l},idle:function(){return O._tasks.length+c===0},pause:function(){O.paused=!0},resume:function(){O.paused!==!1&&(O.paused=!1,T(O.process))}};return O}function jn(r,s){return qn(r,1,s)}var Pe=H(ye,1);function pe(r,s,a,u){u=ce(u||C);var c=N(a);Pe(r,function(l,d,v){c(s,l,function(E,R){s=R,v(E)})},function(l){u(l,s)})}function Ut(){var r=Te(arguments,N);return function(){var s=i(arguments),a=this,u=s[s.length-1];typeof u=="function"?s.pop():u=C,pe(r,s,function(c,l,d){l.apply(a,c.concat(function(v){var E=i(arguments,1);d(v,E)}))},function(c,l){u.apply(a,[c].concat(l))})}}var Fn=function(){return Ut.apply(null,i(arguments).reverse())},fo=Array.prototype.concat,ut=function(r,s,a,u){u=u||C;var c=N(a);be(r,s,function(l,d){c(l,function(v){return v?d(v):d(null,i(arguments,1))})},function(l,d){for(var v=[],E=0;E<d.length;E++)d[E]&&(v=fo.apply(v,d[E]));return u(l,v)})},Bn=H(ut,1/0),Vn=H(ut,1),$n=function(){var r=i(arguments),s=[null].concat(r);return function(){var a=arguments[arguments.length-1];return a.apply(this,s)}};function je(r){return r}function De(r,s){return function(a,u,c,l){l=l||C;var d=!1,v;a(u,function(E,R,O){c(E,function(A,j){A?O(A):r(j)&&!v?(d=!0,v=s(!0,E),O(null,Lt)):O()})},function(E){E?l(E):l(null,d?v:s(!1))})}}function Un(r,s){return s}var ft=Re(De(je,Un)),Fe=Se(De(je,Un)),lt=H(Fe,1);function Hn(r){return function(s){var a=i(arguments,1);a.push(function(u){var c=i(arguments,1);typeof console=="object"&&(u?console.error&&console.error(u):console[r]&&ot(c,function(l){console[r](l)}))}),N(s).apply(null,a)}}var Yn=Hn("dir");function Gn(r,s,a){a=re(a||C);var u=N(r),c=N(s);function l(v){if(v)return a(v);var E=i(arguments,1);E.push(d),c.apply(this,E)}function d(v,E){if(v)return a(v);if(!E)return a(null);u(l)}d(null,!0)}function Ht(r,s,a){a=re(a||C);var u=N(r),c=function(l){if(l)return a(l);var d=i(arguments,1);if(s.apply(this,d))return u(c);a.apply(null,[null].concat(d))};u(c)}function kn(r,s,a){Ht(r,function(){return!s.apply(this,arguments)},a)}function xn(r,s,a){a=re(a||C);var u=N(s),c=N(r);function l(v){if(v)return a(v);c(d)}function d(v,E){if(v)return a(v);if(!E)return a(null);u(l)}c(d)}function zn(r){return function(s,a,u){return r(s,u)}}function ct(r,s,a){he(r,zn(N(s)),a)}function Be(r,s,a,u){it(s)(r,zn(N(a)),u)}var Ve=H(Be,1);function Yt(r){return Y(r)?r:f(function(s,a){var u=!0;s.push(function(){var c=arguments;u?T(function(){a.apply(null,c)}):a.apply(null,c)}),r.apply(this,s),u=!1})}function ht(r){return!r}var pt=Re(De(ht,ht)),$e=Se(De(ht,ht)),dt=H($e,1);function Wn(r){return function(s){return s==null?void 0:s[r]}}function lo(r,s,a,u){var c=new Array(s.length);r(s,function(l,d,v){a(l,function(E,R){c[d]=!!R,v(E)})},function(l){if(l)return u(l);for(var d=[],v=0;v<s.length;v++)c[v]&&d.push(s[v]);u(null,d)})}function co(r,s,a,u){var c=[];r(s,function(l,d,v){a(l,function(E,R){E?v(E):(R&&c.push({index:d,value:l}),v())})},function(l){l?u(l):u(null,Te(c.sort(function(d,v){return d.index-v.index}),Wn("value")))})}function Gt(r,s,a,u){var c=Ce(s)?lo:co;c(r,s,N(a),u||C)}var _t=Re(Gt),Ue=Se(Gt),vt=H(Ue,1);function Jn(r,s){var a=re(s||C),u=N(Yt(r));function c(l){if(l)return a(l);u(c)}c()}var gt=function(r,s,a,u){u=u||C;var c=N(a);be(r,s,function(l,d){c(l,function(v,E){return v?d(v):d(null,{key:E,val:l})})},function(l,d){for(var v={},E=Object.prototype.hasOwnProperty,R=0;R<d.length;R++)if(d[R]){var O=d[R].key,A=d[R].val;E.call(v,O)?v[O].push(A):v[O]=[A]}return u(l,v)})},Qn=H(gt,1/0),Xn=H(gt,1),Zn=Hn("log");function yt(r,s,a,u){u=ce(u||C);var c={},l=N(a);ye(r,s,function(d,v,E){l(d,v,function(R,O){if(R)return E(R);c[v]=O,E()})},function(d){u(d,c)})}var Kn=H(yt,1/0),er=H(yt,1);function tr(r,s){return s in r}function nr(r,s){var a=Object.create(null),u=Object.create(null);s=s||je;var c=N(r),l=f(function(v,E){var R=s.apply(null,v);tr(a,R)?T(function(){E.apply(null,a[R])}):tr(u,R)?u[R].push(E):(u[R]=[E],c.apply(null,v.concat(function(){var O=i(arguments);a[R]=O;var A=u[R];delete u[R];for(var j=0,G=A.length;j<G;j++)A[j].apply(null,O)})))});return l.memo=a,l.unmemoized=r,l}var Et;_?Et=process.nextTick:h?Et=setImmediate:Et=g;var rr=y(Et);function kt(r,s,a){a=a||C;var u=Ce(s)?[]:{};r(s,function(c,l,d){N(c)(function(v,E){arguments.length>2&&(E=i(arguments,1)),u[l]=E,d(v)})},function(c){a(c,u)})}function ir(r,s){kt(he,r,s)}function sr(r,s,a){kt(it(s),r,a)}var xt=function(r,s){var a=N(r);return qn(function(u,c){a(u[0],c)},s,1)},or=function(r,s){var a=xt(r,s);return a.push=function(u,c,l){if(l==null&&(l=C),typeof l!="function")throw new Error("task callback must be a function");if(a.started=!0,X(u)||(u=[u]),u.length===0)return T(function(){a.drain()});c=c||0;for(var d=a._tasks.head;d&&c>=d.priority;)d=d.next;for(var v=0,E=u.length;v<E;v++){var R={data:u[v],priority:c,callback:l};d?a._tasks.insertBefore(d,R):a._tasks.push(R)}T(a.process)},delete a.unshift,a};function ar(r,s){if(s=ce(s||C),!X(r))return s(new TypeError("First argument to race must be an array of functions"));if(!r.length)return s();for(var a=0,u=r.length;a<u;a++)N(r[a])(s)}function mt(r,s,a,u){var c=i(r).reverse();pe(c,s,a,u)}function Ot(r){var s=N(r);return f(function(u,c){return u.push(function(d,v){if(d)c(null,{error:d});else{var E;arguments.length<=2?E=v:E=i(arguments,1),c(null,{value:E})}}),s.apply(this,u)})}function ur(r){var s;return X(r)?s=Te(r,Ot):(s={},qe(r,function(a,u){s[u]=Ot.call(this,a)})),s}function fr(r,s,a,u){Gt(r,s,function(c,l){a(c,function(d,v){l(d,!v)})},u)}var lr=Re(fr),zt=Se(fr),cr=H(zt,1);function hr(r){return function(){return r}}function Rt(r,s,a){var u=5,c=0,l={times:u,intervalFunc:hr(c)};function d(O,A){if(typeof A=="object")O.times=+A.times||u,O.intervalFunc=typeof A.interval=="function"?A.interval:hr(+A.interval||c),O.errorFilter=A.errorFilter;else if(typeof A=="number"||typeof A=="string")O.times=+A||u;else throw new Error("Invalid arguments for async.retry")}if(arguments.length<3&&typeof r=="function"?(a=s||C,s=r):(d(l,r),a=a||C),typeof s!="function")throw new Error("Invalid arguments for async.retry");var v=N(s),E=1;function R(){v(function(O){O&&E++<l.times&&(typeof l.errorFilter!="function"||l.errorFilter(O))?setTimeout(R,l.intervalFunc(E)):a.apply(null,arguments)})}R()}var pr=function(r,s){s||(s=r,r=null);var a=N(s);return f(function(u,c){function l(d){a.apply(null,u.concat(d))}r?Rt(r,l,c):Rt(l,c)})};function dr(r,s){kt(Pe,r,s)}var St=Re(De(Boolean,je)),He=Se(De(Boolean,je)),bt=H(He,1);function _r(r,s,a){var u=N(s);st(r,function(l,d){u(l,function(v,E){if(v)return d(v);d(null,{value:l,criteria:E})})},function(l,d){if(l)return a(l);a(null,Te(d.sort(c),Wn("value")))});function c(l,d){var v=l.criteria,E=d.criteria;return v<E?-1:v>E?1:0}}function vr(r,s,a){var u=N(r);return f(function(c,l){var d=!1,v;function E(){var R=r.name||"anonymous",O=new Error('Callback function "'+R+'" timed out.');O.code="ETIMEDOUT",a&&(O.info=a),d=!0,l(O)}c.push(function(){d||(l.apply(null,arguments),clearTimeout(v))}),v=setTimeout(E,s),u.apply(null,c)})}var ho=Math.ceil,po=Math.max;function _o(r,s,a,u){for(var c=-1,l=po(ho((s-r)/(a||1)),0),d=Array(l);l--;)d[u?l:++c]=r,r+=a;return d}function Tt(r,s,a,u){var c=N(a);be(_o(0,r,1),s,c,u)}var gr=H(Tt,1/0),yr=H(Tt,1);function Er(r,s,a,u){arguments.length<=3&&(u=a,a=s,s=X(r)?[]:{}),u=ce(u||C);var c=N(a);he(r,function(l,d,v){c(s,l,d,v)},function(l){u(l,s)})}function mr(r,s){var a=null,u;s=s||C,Ve(r,function(c,l){N(c)(function(d,v){arguments.length>2?u=i(arguments,1):u=v,a=d,l(!d)})},function(){s(a,u)})}function Or(r){return function(){return(r.unmemoized||r).apply(null,arguments)}}function Wt(r,s,a){a=re(a||C);var u=N(s);if(!r())return a(null);var c=function(l){if(l)return a(l);if(r())return u(c);var d=i(arguments,1);a.apply(null,[null].concat(d))};u(c)}function Rr(r,s,a){Wt(function(){return!r.apply(this,arguments)},s,a)}var Sr=function(r,s){if(s=ce(s||C),!X(r))return s(new Error("First argument to waterfall must be an array of functions"));if(!r.length)return s();var a=0;function u(l){var d=N(r[a++]);l.push(re(c)),d.apply(null,l)}function c(l){if(l||a===r.length)return s.apply(null,arguments);u(i(arguments,1))}u([])},vo={apply:o,applyEach:Rn,applyEachSeries:Sn,asyncify:P,auto:Ft,autoInject:Cn,cargo:jn,compose:Fn,concat:Bn,concatLimit:ut,concatSeries:Vn,constant:$n,detect:ft,detectLimit:Fe,detectSeries:lt,dir:Yn,doDuring:Gn,doUntil:kn,doWhilst:Ht,during:xn,each:ct,eachLimit:Be,eachOf:he,eachOfLimit:ye,eachOfSeries:Pe,eachSeries:Ve,ensureAsync:Yt,every:pt,everyLimit:$e,everySeries:dt,filter:_t,filterLimit:Ue,filterSeries:vt,forever:Jn,groupBy:Qn,groupByLimit:gt,groupBySeries:Xn,log:Zn,map:st,mapLimit:be,mapSeries:jt,mapValues:Kn,mapValuesLimit:yt,mapValuesSeries:er,memoize:nr,nextTick:rr,parallel:ir,parallelLimit:sr,priorityQueue:or,queue:xt,race:ar,reduce:pe,reduceRight:mt,reflect:Ot,reflectAll:ur,reject:lr,rejectLimit:zt,rejectSeries:cr,retry:Rt,retryable:pr,seq:Ut,series:dr,setImmediate:T,some:St,someLimit:He,someSeries:bt,sortBy:_r,timeout:vr,times:gr,timesLimit:Tt,timesSeries:yr,transform:Er,tryEach:mr,unmemoize:Or,until:Rr,waterfall:Sr,whilst:Wt,all:pt,allLimit:$e,allSeries:dt,any:St,anyLimit:He,anySeries:bt,find:ft,findLimit:Fe,findSeries:lt,forEach:ct,forEachSeries:Ve,forEachLimit:Be,forEachOf:he,forEachOfSeries:Pe,forEachOfLimit:ye,inject:pe,foldl:pe,foldr:mt,select:_t,selectLimit:Ue,selectSeries:vt,wrapSync:P};n.default=vo,n.apply=o,n.applyEach=Rn,n.applyEachSeries=Sn,n.asyncify=P,n.auto=Ft,n.autoInject=Cn,n.cargo=jn,n.compose=Fn,n.concat=Bn,n.concatLimit=ut,n.concatSeries=Vn,n.constant=$n,n.detect=ft,n.detectLimit=Fe,n.detectSeries=lt,n.dir=Yn,n.doDuring=Gn,n.doUntil=kn,n.doWhilst=Ht,n.during=xn,n.each=ct,n.eachLimit=Be,n.eachOf=he,n.eachOfLimit=ye,n.eachOfSeries=Pe,n.eachSeries=Ve,n.ensureAsync=Yt,n.every=pt,n.everyLimit=$e,n.everySeries=dt,n.filter=_t,n.filterLimit=Ue,n.filterSeries=vt,n.forever=Jn,n.groupBy=Qn,n.groupByLimit=gt,n.groupBySeries=Xn,n.log=Zn,n.map=st,n.mapLimit=be,n.mapSeries=jt,n.mapValues=Kn,n.mapValuesLimit=yt,n.mapValuesSeries=er,n.memoize=nr,n.nextTick=rr,n.parallel=ir,n.parallelLimit=sr,n.priorityQueue=or,n.queue=xt,n.race=ar,n.reduce=pe,n.reduceRight=mt,n.reflect=Ot,n.reflectAll=ur,n.reject=lr,n.rejectLimit=zt,n.rejectSeries=cr,n.retry=Rt,n.retryable=pr,n.seq=Ut,n.series=dr,n.setImmediate=T,n.some=St,n.someLimit=He,n.someSeries=bt,n.sortBy=_r,n.timeout=vr,n.times=gr,n.timesLimit=Tt,n.timesSeries=yr,n.transform=Er,n.tryEach=mr,n.unmemoize=Or,n.until=Rr,n.waterfall=Sr,n.whilst=Wt,n.all=pt,n.allLimit=$e,n.allSeries=dt,n.any=St,n.anyLimit=He,n.anySeries=bt,n.find=ft,n.findLimit=Fe,n.findSeries=lt,n.forEach=ct,n.forEachSeries=Ve,n.forEachLimit=Be,n.forEachOf=he,n.forEachOfSeries=Pe,n.forEachOfLimit=ye,n.inject=pe,n.foldl=pe,n.foldr=mt,n.select=_t,n.selectLimit=Ue,n.selectSeries=vt,n.wrapSync=P,Object.defineProperty(n,"__esModule",{value:!0})})})(Dt,Dt.exports);var xo=Dt.exports,Yr={exports:{}},rn=Yr.exports=function(e,t){if(t||(t=16),e===void 0&&(e=128),e<=0)return"0";for(var n=Math.log(Math.pow(2,e))/Math.log(t),i=2;n===1/0;i*=2)n=Math.log(Math.pow(2,e/i))/Math.log(t)*i;for(var o=n-Math.floor(n),f="",i=0;i<Math.floor(n);i++){var p=Math.floor(Math.random()*t).toString(t);f=p+f}if(o){var h=Math.pow(t,o),p=Math.floor(Math.random()*h).toString(t);f=p+f}var _=parseInt(f,t);return _!==1/0&&_>=Math.pow(2,e)?rn(e,t):f};rn.rack=function(e,t,n){var i=function(f){var p=0;do{if(p++>10)if(n)e+=n;else throw new Error("too many ID collisions, use more bits");var h=rn(e,t)}while(Object.hasOwnProperty.call(o,h));return o[h]=f,h},o=i.hats={};return i.get=function(f){return i.hats[f]},i.set=function(f,p){return i.hats[f]=p,i},i.bits=e||128,i.base=t||16,i};var zo=Yr.exports,Gr=de,Wo=Ur,Jo=Hr,At=J,Zt=xo,Qo=zo,Dr=ve.ACTIONS,kr=$;function $(e,t){if(Gr.EventEmitter.call(this),!t||typeof t!="string")throw new Error("Presence channel must be provided");this.connection=e,this.channel=t,this.wantSubscribe=!1,this.subscribed=!1,this.remotePresences={},this.localPresences={},this._remotePresenceInstances={},this._subscriptionCallbacksBySeq={},this._wantsDestroy=!1}Gr.mixin($);$.prototype.subscribe=function(e){this._sendSubscriptionAction(!0,e)};$.prototype.unsubscribe=function(e){this._sendSubscriptionAction(!1,e)};$.prototype.create=function(e){if(this._wantsDestroy)throw new Error("Presence is being destroyed");e=e||Qo();var t=this._createLocalPresence(e);return this.localPresences[e]=t,t};$.prototype.destroy=function(e){this._wantsDestroy=!0;var t=this,n=Object.keys(t.localPresences);this.unsubscribe(function(i){if(i)return t._callbackOrEmit(i,e);var o=Object.keys(t._remotePresenceInstances);Zt.parallel([function(f){Zt.each(n,function(p,h){t.localPresences[p].destroy(h)},f)},function(f){if(!t._wantsDestroy)return f();Zt.each(o,function(p,h){t._remotePresenceInstances[p].destroy(h)},f)}],function(f){t._wantsDestroy&&delete t.connection._presences[t.channel],t._callbackOrEmit(f,e)})})};$.prototype._sendSubscriptionAction=function(e,t){this.wantSubscribe=!!e;var n=this.wantSubscribe?Dr.presenceSubscribe:Dr.presenceUnsubscribe,i=this.connection._presenceSeq++;this._subscriptionCallbacksBySeq[i]=t,this.connection.canSend&&this.connection._sendPresenceAction(n,i,this)};$.prototype._handleSubscribe=function(e,t){this.wantSubscribe&&(this.subscribed=!0);var n=this._subscriptionCallback(t);this._callbackOrEmit(e,n)};$.prototype._handleUnsubscribe=function(e,t){this.subscribed=!1;var n=this._subscriptionCallback(t);this._callbackOrEmit(e,n)};$.prototype._receiveUpdate=function(e,t){var n=At.dig(this.localPresences,t.id);if(n)return n._ack(e,t.pv);if(e)return this.emit("error",e);var i=this,o=At.digOrCreate(this._remotePresenceInstances,t.id,function(){return i._createRemotePresence(t.id)});o.receiveUpdate(t)};$.prototype._updateRemotePresence=function(e){this.remotePresences[e.presenceId]=e.value,e.value===null&&this._removeRemotePresence(e.presenceId),this.emit("receive",e.presenceId,e.value)};$.prototype._broadcastAllLocalPresence=function(e){if(e)return this.emit("error",e);for(var t in this.localPresences){var n=this.localPresences[t];n.value!==null&&n.send()}};$.prototype._removeRemotePresence=function(e){this._remotePresenceInstances[e].destroy(),delete this._remotePresenceInstances[e],delete this.remotePresences[e]};$.prototype._onConnectionStateChanged=function(){if(this.connection.canSend){this._resubscribe();for(var e in this.localPresences)this.localPresences[e]._sendPending()}};$.prototype._resubscribe=function(){var e=[];for(var t in this._subscriptionCallbacksBySeq){var n=this._subscriptionCallback(t);e.push(n)}if(!this.wantSubscribe)return this._callEachOrEmit(e);var i=this;this.subscribe(function(o){i._callEachOrEmit(e,o)})};$.prototype._subscriptionCallback=function(e){var t=this._subscriptionCallbacksBySeq[e];return delete this._subscriptionCallbacksBySeq[e],t};$.prototype._callbackOrEmit=function(e,t){if(t)return At.nextTick(t,e);e&&this.emit("error",e)};$.prototype._createLocalPresence=function(e){return new Wo(this,e)};$.prototype._createRemotePresence=function(e){return new Jo(this,e)};$.prototype._callEachOrEmit=function(e,t){var n=At.callEach(e,t);!n&&t&&this.emit("error",t)};var Xe=Ur,xr=Je,Xo=J,zr=xr.CODES,Zo=te;function te(e,t){Xe.call(this,e,t),this.collection=this.presence.collection,this.id=this.presence.id,this._doc=this.connection.get(this.collection,this.id),this._emitter=this.connection._docPresenceEmitter,this._isSending=!1,this._docDataVersionByPresenceVersion={},this._opHandler=this._transformAgainstOp.bind(this),this._createOrDelHandler=this._handleCreateOrDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._destroyHandler=this.destroy.bind(this),this._registerWithDoc()}te.prototype=Object.create(Xe.prototype);te.prototype.submit=function(e,t){if(!this._doc.type){if(e===null)return this._callbackOrEmit(null,t);var n={code:zr.ERR_DOC_DOES_NOT_EXIST,message:"Cannot submit presence. Document has not been created"};return this._callbackOrEmit(n,t)}this._docDataVersionByPresenceVersion[this.presenceVersion]=this._doc._dataStateVersion,Xe.prototype.submit.call(this,e,t)};te.prototype.destroy=function(e){this._emitter.removeEventListener(this._doc,"op",this._opHandler),this._emitter.removeEventListener(this._doc,"create",this._createOrDelHandler),this._emitter.removeEventListener(this._doc,"del",this._createOrDelHandler),this._emitter.removeEventListener(this._doc,"load",this._loadHandler),this._emitter.removeEventListener(this._doc,"destroy",this._destroyHandler),Xe.prototype.destroy.call(this,e)};te.prototype._sendPending=function(){if(!this._isSending){this._isSending=!0;var e=this;this._doc.whenNothingPending(function(){e._isSending=!1,e.connection.canSend&&(e._pendingMessages.forEach(function(t){t.t=e._doc.type.uri,t.v=e._doc.version,e.connection.send(t)}),e._pendingMessages=[],e._docDataVersionByPresenceVersion={})})}};te.prototype._registerWithDoc=function(){this._emitter.addEventListener(this._doc,"op",this._opHandler),this._emitter.addEventListener(this._doc,"create",this._createOrDelHandler),this._emitter.addEventListener(this._doc,"del",this._createOrDelHandler),this._emitter.addEventListener(this._doc,"load",this._loadHandler),this._emitter.addEventListener(this._doc,"destroy",this._destroyHandler)};te.prototype._transformAgainstOp=function(e,t){var n=this,i=this._doc._dataStateVersion;this._pendingMessages.forEach(function(o){var f=n._docDataVersionByPresenceVersion[o.pv];if(!(f>=i))try{o.p=n._transformPresence(o.p,e,t),n._docDataVersionByPresenceVersion[o.pv]=i}catch(h){var p=n._getCallback(o.pv);n._callbackOrEmit(h,p)}});try{this.value=this._transformPresence(this.value,e,t)}catch(o){this.emit("error",o)}};te.prototype._handleCreateOrDel=function(){this._pendingMessages.forEach(function(e){e.p=null}),this.value=null};te.prototype._handleLoad=function(){this.value=null,this._pendingMessages=[],this._docDataVersionByPresenceVersion={}};te.prototype._message=function(){var e=Xe.prototype._message.call(this);return e.c=this.collection,e.d=this.id,e.v=null,e.t=null,e};te.prototype._transformPresence=function(e,t,n){var i=this._doc.type;if(!Xo.supportsPresence(i))throw new xr(zr.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,"Type does not support presence: "+i.name);return i.transformPresence(e,t,n)};var Wr={};(function(e){var t=Qe,n=Je,i=J,o=n.CODES;e.checkOp=function(h){if(h==null||typeof h!="object")return new n(o.ERR_OT_OP_BADLY_FORMED,"Op must be an object");if(h.create!=null){if(typeof h.create!="object")return new n(o.ERR_OT_OP_BADLY_FORMED,"Create data must be an object");var _=h.create.type;if(typeof _!="string")return new n(o.ERR_OT_OP_BADLY_FORMED,"Missing create type");var g=t.map[_];if(g==null||typeof g!="object")return new n(o.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type")}else if(h.del!=null){if(h.del!==!0)return new n(o.ERR_OT_OP_BADLY_FORMED,"del value must be true")}else if(!("op"in h))return new n(o.ERR_OT_OP_BADLY_FORMED,"Missing op, create, or del");if(h.src!=null&&typeof h.src!="string")return new n(o.ERR_OT_OP_BADLY_FORMED,"src must be a string");if(h.seq!=null&&typeof h.seq!="number")return new n(o.ERR_OT_OP_BADLY_FORMED,"seq must be a number");if(h.src==null&&h.seq!=null||h.src!=null&&h.seq==null)return new n(o.ERR_OT_OP_BADLY_FORMED,"Both src and seq must be set together");if(h.m!=null&&typeof h.m!="object")return new n(o.ERR_OT_OP_BADLY_FORMED,"op.m must be an object or null")},e.normalizeType=function(h){return t.map[h]&&t.map[h].uri},e.apply=function(h,_){if(typeof h!="object")return new n(o.ERR_APPLY_SNAPSHOT_NOT_PROVIDED,"Missing snapshot");if(h.v!=null&&_.v!=null&&h.v!==_.v)return new n(o.ERR_APPLY_OP_VERSION_DOES_NOT_MATCH_SNAPSHOT,"Version mismatch");if(_.create){if(h.type)return new n(o.ERR_DOC_ALREADY_CREATED,"Document already exists");var g=_.create,y=t.map[g.type];if(!y)return new n(o.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{h.data=y.create(g.data),h.type=y.uri,h.v++}catch(T){return T}}else if(_.del)h.data=void 0,h.type=null,h.v++;else if("op"in _){var m=f(h,_.op);if(m)return m;h.v++}else h.v++};function f(h,_){if(!h.type)return new n(o.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(_===void 0)return new n(o.ERR_OT_OP_NOT_PROVIDED,"Missing op");var g=t.map[h.type];if(!g)return new n(o.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{h.data=g.apply(h.data,_)}catch(y){return new n(o.ERR_OT_OP_NOT_APPLIED,y.message)}}e.transform=function(h,_,g){if(_.v!=null&&_.v!==g.v)return new n(o.ERR_OP_VERSION_MISMATCH_DURING_TRANSFORM,"Version mismatch");if(g.del){if(_.create||"op"in _)return new n(o.ERR_DOC_WAS_DELETED,"Document was deleted")}else{if(g.create&&("op"in _||_.create||_.del)||"op"in g&&_.create)return new n(o.ERR_DOC_ALREADY_CREATED,"Document was created remotely");if("op"in g&&"op"in _){if(!h)return new n(o.ERR_DOC_DOES_NOT_EXIST,"Document does not exist");if(typeof h=="string"&&(h=t.map[h],!h))return new n(o.ERR_DOC_TYPE_NOT_RECOGNIZED,"Unknown type");try{_.op=h.transform(_.op,g.op,"left")}catch(y){return y}}}_.v!=null&&_.v++},e.applyOps=function(h,_,g){g=g||{};for(var y=0;y<_.length;y++){var m=_[y];if(g._normalizeLegacyJson0Ops)try{p(h,m)}catch{return new n(o.ERR_OT_LEGACY_JSON0_OP_CANNOT_BE_NORMALIZED,"Cannot normalize legacy json0 op")}h.v=m.v;var T=e.apply(h,m);if(T)return T}},e.transformPresence=function(h,_,g){var y=this.checkOp(_);if(y)return y;var m=h.t;if(typeof m=="string"&&(m=t.map[m]),!m)return{code:o.ERR_DOC_TYPE_NOT_RECOGNIZED,message:"Unknown type"};if(!i.supportsPresence(m))return{code:o.ERR_TYPE_DOES_NOT_SUPPORT_PRESENCE,message:"Type does not support presence"};if(_.create||_.del){h.p=null,h.v++;return}try{h.p=h.p===null?null:m.transformPresence(h.p,_.op,g)}catch(T){return{code:o.ERR_PRESENCE_TRANSFORM_FAILED,message:T.message||T}}h.v++};function p(h,_){if(h.type===t.defaultType.uri){var g=_.op;if(g){var y=h.data;g.length>1&&(y=i.clone(y));for(var m=0;m<g.length;m++){var T=g[m];typeof T.lm=="string"&&(T.lm=+T.lm);for(var P=T.p,b=y,L=0;L<P.length;L++){var S=P[L];Object.prototype.toString.call(b)=="[object Array]"?P[L]=+S:b.constructor===Object&&(P[L]=S.toString()),b=b[S]}m<g.length-1&&(y=t.defaultType.apply(y,[T]))}}}}})(Wr);var Ze=Hr,Ko=Wr,ea=Q;function Q(e,t){Ze.call(this,e,t),this.collection=this.presence.collection,this.id=this.presence.id,this.src=null,this.presenceVersion=null,this._doc=this.connection.get(this.collection,this.id),this._emitter=this.connection._docPresenceEmitter,this._pending=null,this._opCache=null,this._pendingSetPending=!1,this._opHandler=this._handleOp.bind(this),this._createDelHandler=this._handleCreateDel.bind(this),this._loadHandler=this._handleLoad.bind(this),this._registerWithDoc()}Q.prototype=Object.create(Ze.prototype);Q.prototype.receiveUpdate=function(e){this._pending&&e.pv<this._pending.pv||(this.src=e.src,this._pending=e,this._setPendingPresence())};Q.prototype.destroy=function(e){this._emitter.removeEventListener(this._doc,"op",this._opHandler),this._emitter.removeEventListener(this._doc,"create",this._createDelHandler),this._emitter.removeEventListener(this._doc,"del",this._createDelHandler),this._emitter.removeEventListener(this._doc,"load",this._loadHandler),Ze.prototype.destroy.call(this,e)};Q.prototype._registerWithDoc=function(){this._emitter.addEventListener(this._doc,"op",this._opHandler),this._emitter.addEventListener(this._doc,"create",this._createDelHandler),this._emitter.addEventListener(this._doc,"del",this._createDelHandler),this._emitter.addEventListener(this._doc,"load",this._loadHandler)};Q.prototype._setPendingPresence=function(){if(!this._pendingSetPending){this._pendingSetPending=!0;var e=this;this._doc.whenNothingPending(function(){if(e._pendingSetPending=!1,!!e._pending){if(e._pending.pv<e.presenceVersion)return e._pending=null;if(e._pending.v>e._doc.version)return e._doc.fetch();e._catchUpStalePresence()&&(e.value=e._pending.p,e.presenceVersion=e._pending.pv,e._pending=null,e.presence._updateRemotePresence(e))}})}};Q.prototype._handleOp=function(e,t,n){var i=n===this.src;this._transformAgainstOp(e,i),this._cacheOp(e,i),this._setPendingPresence()};Ze.prototype._handleCreateDel=function(){this._cacheOp(null),this._setPendingPresence()};Ze.prototype._handleLoad=function(){this.value=null,this._pending=null,this._opCache=null,this.presence._updateRemotePresence(this)};Q.prototype._transformAgainstOp=function(e,t){if(this.value){try{this.value=this._doc.type.transformPresence(this.value,e,t)}catch(n){return this.presence.emit("error",n)}this.presence._updateRemotePresence(this)}};Q.prototype._catchUpStalePresence=function(){if(this._pending.v>=this._doc.version)return!0;if(!this._opCache)return this._startCachingOps(),this._doc.fetch(),this.presence.subscribe(),!1;for(;this._opCache[this._pending.v];){var e=this._opCache[this._pending.v],t=e.op,n=e.isOwnOp;t===null?(this._pending.p=null,this._pending.v++):Ko.transformPresence(this._pending,t,n)}var i=this._pending.v>=this._doc.version;return i&&this._stopCachingOps(),i};Q.prototype._startCachingOps=function(){this._opCache=[]};Q.prototype._stopCachingOps=function(){this._opCache=null};Q.prototype._cacheOp=function(e,t){this._opCache&&(e=e?{op:e}:null,this._opCache[this._doc.version-1]={op:e,isOwnOp:t})};var Jr=kr,ta=Zo,na=ea;function we(e,t,n){var i=we.channel(t,n);Jr.call(this,e,i),this.collection=t,this.id=n}var ra=we;we.prototype=Object.create(Jr.prototype);we.channel=function(e,t){return e+"."+t};we.prototype._createLocalPresence=function(e){return new ta(this,e)};we.prototype._createRemotePresence=function(e){return new na(this,e)};var ia=sa;function sa(e,t,n,i,o){this.id=e,this.v=t,this.type=n,this.data=i,this.m=o}var oa=ia,Qr=de,Xr=Ke;function Ke(e,t,n,i,o){if(Qr.EventEmitter.call(this),typeof o!="function")throw new Error("Callback is required for SnapshotRequest");this.requestId=t,this.connection=e,this.id=i,this.collection=n,this.callback=o,this.sent=!1}Qr.mixin(Ke);Ke.prototype.send=function(){this.connection.canSend&&(this.connection.send(this._message()),this.sent=!0)};Ke.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.sent||this.send():this.sent=!1};Ke.prototype._handleResponse=function(e,t){if(this.emit("ready"),e)return this.callback(e);var n=t.meta?t.meta:null,i=new oa(this.id,t.v,t.type,t.data,n);this.callback(null,i)};var Zr=Xr,aa=J,ua=ve.ACTIONS,fa=an;function an(e,t,n,i,o,f){if(Zr.call(this,e,t,n,i,f),!aa.isValidVersion(o))throw new Error("Snapshot version must be a positive integer or null");this.version=o}an.prototype=Object.create(Zr.prototype);an.prototype._message=function(){return{a:ua.snapshotFetch,id:this.requestId,c:this.collection,d:this.id,v:this.version}};var Kr=Xr,la=J,ca=ve.ACTIONS,ha=un;function un(e,t,n,i,o,f){if(Kr.call(this,e,t,n,i,f),!la.isValidTimestamp(o))throw new Error("Snapshot timestamp must be a positive integer or null");this.timestamp=o}un.prototype=Object.create(Kr.prototype);un.prototype._message=function(){return{a:ca.snapshotFetchByTimestamp,id:this.requestId,c:this.collection,d:this.id,ts:this.timestamp}};var oe=J,pa=wr.EventEmitter,da=["create","del","destroy","load","op"],_a=et;function et(){this._docs={},this._forwarders={},this._emitters={}}et.prototype.addEventListener=function(e,t,n){this._registerDoc(e);var i=oe.dig(this._emitters,e.collection,e.id);i.on(t,n)};et.prototype.removeEventListener=function(e,t,n){var i=oe.dig(this._emitters,e.collection,e.id);i&&(i.off(t,n),i._eventsCount===1&&this._unregisterDoc(e))};et.prototype._registerDoc=function(e){var t=!0;if(oe.digOrCreate(this._docs,e.collection,e.id,function(){return t=!1,e}),!t){var n=oe.digOrCreate(this._emitters,e.collection,e.id,function(){var o=new pa;return o.setMaxListeners(1e3),o}),i=this;da.forEach(function(o){var f=oe.digOrCreate(i._forwarders,e.collection,e.id,o,function(){return n.emit.bind(n,o)});e.on(o,f)}),this.addEventListener(e,"destroy",this._unregisterDoc.bind(this,e))}};et.prototype._unregisterDoc=function(e){var t=oe.dig(this._forwarders,e.collection,e.id);for(var n in t)e.off(n,t[n]);var i=oe.dig(this._emitters,e.collection,e.id);i.removeAllListeners(),oe.digAndRemove(this._forwarders,e.collection,e.id),oe.digAndRemove(this._emitters,e.collection,e.id),oe.digAndRemove(this._docs,e.collection,e.id)};var va=Fr,ga=Vr,ya=kr,Ar=ra,Ea=fa,ma=ha,ei=de,Ie=Je,M=ve.ACTIONS,Nr=Qe,ne=J,We=sn,Oa=_a,ke=Ie.CODES;function ti(e){return e.readyState===0||e.readyState===1?"connecting":"disconnected"}var Ra=D;function D(e){ei.EventEmitter.call(this),this.collections={},this.nextQueryId=1,this.nextSnapshotRequestId=1,this.queries={},this._presences={},this._docPresenceEmitter=new Oa,this._snapshotRequests={},this.seq=1,this._presenceSeq=1,this.id=null,this.agent=null,this.debug=!1,this.state=ti(e),this.bindToSocket(e)}ei.mixin(D);D.prototype.bindToSocket=function(e){this.socket&&(this.socket.close(),this.socket.onmessage=null,this.socket.onopen=null,this.socket.onerror=null,this.socket.onclose=null),this.socket=e;var t=ti(e);this._setState(t),this.canSend=!1;var n=this;e.onmessage=function(i){try{var o=typeof i.data=="string"?JSON.parse(i.data):i.data}catch{We.warn("Failed to parse message",i);return}n.debug&&We.info("RECV",JSON.stringify(o));var f={data:o};if(n.emit("receive",f),!!f.data)try{n.handleMessage(f.data)}catch(p){ne.nextTick(function(){n.emit("error",p)})}},e.readyState===1&&n._initializeHandshake(),e.onopen=function(){n._setState("connecting"),n._initializeHandshake()},e.onerror=function(i){n.emit("connection error",i)},e.onclose=function(i){i==="closed"||i==="Closed"?n._setState("closed",i):i==="stopped"||i==="Stopped by server"?n._setState("stopped",i):n._setState("disconnected",i)}};D.prototype.handleMessage=function(e){var t=null;switch(e.error&&(t=ni(e.error,e),delete e.error),e.a){case M.initLegacy:return this._handleLegacyInit(e);case M.handshake:return this._handleHandshake(t,e);case M.queryFetch:var n=this.queries[e.id];n&&n._handleFetch(t,e.data,e.extra);return;case M.querySubscribe:var n=this.queries[e.id];n&&n._handleSubscribe(t,e.data,e.extra);return;case M.queryUnsubscribe:return;case M.queryUpdate:var n=this.queries[e.id];if(!n)return;if(t)return n._handleError(t);e.diff&&n._handleDiff(e.diff),e.hasOwnProperty("extra")&&n._handleExtra(e.extra);return;case M.bulkFetch:return this._handleBulkMessage(t,e,"_handleFetch");case M.bulkSubscribe:case M.bulkUnsubscribe:return this._handleBulkMessage(t,e,"_handleSubscribe");case M.snapshotFetch:case M.snapshotFetchByTimestamp:return this._handleSnapshotFetch(t,e);case M.fetch:var i=this.getExisting(e.c,e.d);i&&i._handleFetch(t,e.data);return;case M.subscribe:case M.unsubscribe:var i=this.getExisting(e.c,e.d);i&&i._handleSubscribe(t,e.data);return;case M.op:var i=this.getExisting(e.c,e.d);i&&i._handleOp(t,e);return;case M.presence:return this._handlePresence(t,e);case M.presenceSubscribe:return this._handlePresenceSubscribe(t,e);case M.presenceUnsubscribe:return this._handlePresenceUnsubscribe(t,e);case M.presenceRequest:return this._handlePresenceRequest(t,e);case M.pingPong:return this._handlePingPong(t);default:We.warn("Ignoring unrecognized message",e)}};function ni(e,t){var n=new Error(e.message);return n.code=e.code,t&&(n.data=t),n}D.prototype._handleBulkMessage=function(e,t,n){if(t.data)for(var i in t.data){var o=t.data[i],f=this.getExisting(t.c,i);f&&(e?f[n](e):o.error?f[n](ni(o.error)):f[n](null,o))}else if(Array.isArray(t.b))for(var p=0;p<t.b.length;p++){var i=t.b[p],f=this.getExisting(t.c,i);f&&f[n](e)}else if(t.b)for(var i in t.b){var f=this.getExisting(t.c,i);f&&f[n](e)}else We.error("Invalid bulk message",t)};D.prototype._reset=function(){this.agent=null};D.prototype._setState=function(e,t){if(this.state!==e){if(e==="connecting"&&this.state!=="disconnected"&&this.state!=="stopped"&&this.state!=="closed"||e==="connected"&&this.state!=="connecting"){var n=new Ie(ke.ERR_CONNECTION_STATE_TRANSITION_INVALID,"Cannot transition directly from "+this.state+" to "+e);return this.emit("error",n)}this.state=e,this.canSend=e==="connected",(e==="disconnected"||e==="stopped"||e==="closed")&&this._reset(),this.startBulk();for(var i in this.queries){var o=this.queries[i];o._onConnectionStateChanged()}for(var f in this.collections){var p=this.collections[f];for(var i in p)p[i]._onConnectionStateChanged()}for(var h in this._presences)this._presences[h]._onConnectionStateChanged();for(var i in this._snapshotRequests){var _=this._snapshotRequests[i];_._onConnectionStateChanged()}this.endBulk(),this.emit(e,t),this.emit("state",e,t)}};D.prototype.startBulk=function(){this.bulk||(this.bulk={})};D.prototype.endBulk=function(){if(this.bulk)for(var e in this.bulk){var t=this.bulk[e];this._sendBulk("f",e,t.f),this._sendBulk("s",e,t.s),this._sendBulk("u",e,t.u)}this.bulk=null};D.prototype._sendBulk=function(e,t,n){if(n){var i=[],o={},f=0,p;for(var h in n){var _=n[h];_==null?i.push(h):(o[h]=_,p=h,f++)}if(i.length===1){var h=i[0];this.send({a:e,c:t,d:h})}else i.length&&this.send({a:"b"+e,c:t,b:i});if(f===1){var g=o[p];this.send({a:e,c:t,d:p,v:g})}else f&&this.send({a:"b"+e,c:t,b:o})}};D.prototype._sendActions=function(e,t,n){if(this._addDoc(t),this.bulk){var i=this.bulk[t.collection]||(this.bulk[t.collection]={}),o=i[e]||(i[e]={}),f=o.hasOwnProperty(t.id);return o[t.id]=n,f}else{var p={a:e,c:t.collection,d:t.id,v:n};this.send(p)}};D.prototype.sendFetch=function(e){return this._sendActions(M.fetch,e,e.version)};D.prototype.sendSubscribe=function(e){return this._sendActions(M.subscribe,e,e.version)};D.prototype.sendUnsubscribe=function(e){return this._sendActions(M.unsubscribe,e)};D.prototype.sendOp=function(e,t){this._addDoc(e);var n={a:M.op,c:e.collection,d:e.id,v:e.version,src:t.src,seq:t.seq,x:{}};"op"in t&&(n.op=t.op),t.create&&(n.create=t.create),t.del&&(n.del=t.del),e.submitSource&&(n.x.source=t.source),this.send(n)};D.prototype.send=function(e){this.debug&&We.info("SEND",JSON.stringify(e)),this.emit("send",e),this.socket.send(JSON.stringify(e))};D.prototype.ping=function(){if(!this.canSend)throw new Ie(ke.ERR_CANNOT_PING_OFFLINE,"Socket must be CONNECTED to ping");var e={a:M.pingPong};this.send(e)};D.prototype.close=function(){this.socket.close()};D.prototype.getExisting=function(e,t){if(this.collections[e])return this.collections[e][t]};D.prototype.get=function(e,t){var n=this.collections[e]||(this.collections[e]={}),i=n[t];return i||(i=n[t]=new va(this,e,t),this.emit("doc",i)),i._wantsDestroy=!1,i};D.prototype._destroyDoc=function(e){e._wantsDestroy&&(ne.digAndRemove(this.collections,e.collection,e.id),e.emit("destroy"))};D.prototype._addDoc=function(e){var t=this.collections[e.collection];t||(t=this.collections[e.collection]={}),t[e.id]!==e&&(t[e.id]=e)};D.prototype._createQuery=function(e,t,n,i,o){var f=this.nextQueryId++,p=new ga(e,this,f,t,n,i,o);return this.queries[f]=p,p.send(),p};D.prototype._destroyQuery=function(e){delete this.queries[e.id]};D.prototype.createFetchQuery=function(e,t,n,i){return this._createQuery(M.queryFetch,e,t,n,i)};D.prototype.createSubscribeQuery=function(e,t,n,i){return this._createQuery(M.querySubscribe,e,t,n,i)};D.prototype.hasPending=function(){return!!(this._firstDoc(Nt)||this._firstQuery(Nt)||this._firstSnapshotRequest())};function Nt(e){return e.hasPending()}D.prototype.hasWritePending=function(){return!!this._firstDoc(Sa)};function Sa(e){return e.hasWritePending()}D.prototype.whenNothingPending=function(e){var t=this._firstDoc(Nt);if(t){t.once("nothing pending",this._nothingPendingRetry(e));return}var n=this._firstQuery(Nt);if(n){n.once("ready",this._nothingPendingRetry(e));return}var i=this._firstSnapshotRequest();if(i){i.once("ready",this._nothingPendingRetry(e));return}ne.nextTick(e)};D.prototype._nothingPendingRetry=function(e){var t=this;return function(){ne.nextTick(function(){t.whenNothingPending(e)})}};D.prototype._firstDoc=function(e){for(var t in this.collections){var n=this.collections[t];for(var i in n){var o=n[i];if(e(o))return o}}};D.prototype._firstQuery=function(e){for(var t in this.queries){var n=this.queries[t];if(e(n))return n}};D.prototype._firstSnapshotRequest=function(){for(var e in this._snapshotRequests)return this._snapshotRequests[e]};D.prototype.fetchSnapshot=function(e,t,n,i){typeof n=="function"&&(i=n,n=null);var o=this.nextSnapshotRequestId++,f=new Ea(this,o,e,t,n,i);this._snapshotRequests[f.requestId]=f,f.send()};D.prototype.fetchSnapshotByTimestamp=function(e,t,n,i){typeof n=="function"&&(i=n,n=null);var o=this.nextSnapshotRequestId++,f=new ma(this,o,e,t,n,i);this._snapshotRequests[f.requestId]=f,f.send()};D.prototype._handleSnapshotFetch=function(e,t){var n=this._snapshotRequests[t.id];n&&(delete this._snapshotRequests[t.id],n._handleResponse(e,t))};D.prototype._handleLegacyInit=function(e){if(e.protocolMinor)return this._initializeHandshake();this._initialize(e)};D.prototype._initializeHandshake=function(){this.send({a:M.handshake,id:this.id})};D.prototype._handleHandshake=function(e,t){if(e)return this.emit("error",e);this._initialize(t)};D.prototype._handlePingPong=function(e){if(e)return this.emit("error",e);this.emit("pong")};D.prototype._initialize=function(e){if(this.state==="connecting"){if(e.protocol!==1)return this.emit("error",new Ie(ke.ERR_PROTOCOL_VERSION_NOT_SUPPORTED,"Unsupported protocol version: "+e.protocol));if(Nr.map[e.type]!==Nr.defaultType)return this.emit("error",new Ie(ke.ERR_DEFAULT_TYPE_MISMATCH,e.type+" does not match the server default type"));if(typeof e.id!="string")return this.emit("error",new Ie(ke.ERR_CLIENT_ID_BADLY_FORMED,"Client id must be a string"));this.id=e.id,this._setState("connected")}};D.prototype.getPresence=function(e){var t=this,n=ne.digOrCreate(this._presences,e,function(){return new ya(t,e)});return n._wantsDestroy=!1,n};D.prototype.getDocPresence=function(e,t){var n=Ar.channel(e,t),i=this,o=ne.digOrCreate(this._presences,n,function(){return new Ar(i,e,t)});return o._wantsDestroy=!1,o};D.prototype._sendPresenceAction=function(e,t,n){this._addPresence(n);var i={a:e,ch:n.channel,seq:t};return this.send(i),i.seq};D.prototype._addPresence=function(e){ne.digOrCreate(this._presences,e.channel,function(){return e})};D.prototype._handlePresenceSubscribe=function(e,t){var n=ne.dig(this._presences,t.ch);n&&n._handleSubscribe(e,t.seq)};D.prototype._handlePresenceUnsubscribe=function(e,t){var n=ne.dig(this._presences,t.ch);n&&n._handleUnsubscribe(e,t.seq)};D.prototype._handlePresence=function(e,t){var n=ne.dig(this._presences,t.ch);n&&n._receiveUpdate(e,t)};D.prototype._handlePresenceRequest=function(e,t){var n=ne.dig(this._presences,t.ch);n&&n._broadcastAllLocalPresence(e,t)};me.Connection=Ra;me.Doc=Fr;me.Error=Je;me.Query=Vr;me.types=Qe;me.logger=sn;const ba=new WebSocket("ws://localhost:8080"),Ta=new me.Connection(ba),Ne=Ta.get("documents","plaintext");Ne.subscribe(e=>{if(e)throw e;Ne.type===null&&Ne.create({content:""}),Ne.on("op",()=>{console.log("Received change"),document.getElementById("editor").value=Ne.data.content,console.log("Applied received change")})});document.getElementById("editor").addEventListener("input",e=>{console.log("Detected change");const t=[{p:["content"],oi:e.target.value}];Ne.submitOp(t),console.log("Sent change")});
